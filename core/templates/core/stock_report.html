{% extends "core/base.html" %}

{% block title %}Stock Report{% endblock %}

{% block content %}
<div class="page stock-page" style="max-width:1100px;margin:40px auto 60px;padding:0 26px;">

  <style>
    .stock-page{
      --slate-50:#f8fafc;
      --slate-100:#f1f5f9;
      --slate-200:#e2e8f0;
      --slate-300:#cbd5e1;
      --slate-500:#64748b;
      --slate-700:#334155;
      --slate-900:#0f172a;
      --brand:#2563eb;
      --brand-soft:#dbeafe;
      --ok:#047857;
      --ok-soft:#d1fae5;
      --warn:#b45309;
      --warn-soft:#ffedd5;
    }

    /* Mobile-friendly page padding */
    @media (max-width: 640px){
      .stock-page{ padding:0 14px !important; margin:24px auto 40px !important; }
      .stock-page h1{ font-size:24px !important; }
      .stock-page p{ font-size:14px !important; }
    }

    /* Consistent table style */
    .tbl{
      width:100%;
      border-collapse:collapse;
      table-layout:fixed;
      min-width:980px;
      border:1px solid var(--slate-200);
      border-radius:14px;
      overflow:hidden;
    }
    .tbl th, .tbl td{
      border-bottom:1px solid var(--slate-200);
      padding:10px 12px;
      font-size:14px;
      vertical-align:middle;
    }
    .tbl th{
      background:#f8fafc;
      font-weight:700;
      text-align:left;
      color:var(--slate-700);
      position:sticky;
      top:0;
      z-index:1;
    }
    .tbl tbody tr:nth-child(even){ background:#fcfdff; }
    .tbl tbody tr:hover{ background:#f8fbff; }
    .right{ text-align:right; }
    .nowrap{ white-space:nowrap; }
    .truncate{
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    /* Card spacing small screens */
    @media (max-width: 640px){
      .card-pad{ padding:14px 14px 16px !important; }
    }

    /* Chart wrapper */
    .chart-wrap{
      width:100%;
      overflow-x:auto;   /* allow scroll if labels are long */
      overflow-y:hidden;
    }
    .chart-box{
      min-width:920px;   /* give room for long product names */
    }
    @media (max-width: 640px){
      .chart-box{ min-width:980px; } /* mobile: keep readable */
    }
    .chart-box{
      width:100%;
      max-width:100%;
      height:320px;
    }
    @media (max-width: 640px){
      .chart-box{ height:280px; }
    }

    /* Small badge/pill */
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:5px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid var(--slate-200);
      background:#fff;
      color:var(--slate-900);
      white-space:nowrap;
    }

    .sr-hero{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      margin-bottom:18px;
      flex-wrap:wrap;
      gap:14px;
      padding:18px 20px;
      border-radius:20px;
      border:1px solid var(--slate-200);
      background:linear-gradient(180deg,#ffffff,#f8fbff);
      box-shadow:0 10px 24px rgba(15,23,42,0.07);
    }
    .sr-hero h1{
      margin:0 0 6px;
      font-size:30px;
      font-weight:850;
      letter-spacing:-0.02em;
      color:var(--slate-900);
    }
    .sr-hero p{
      margin:0 0 14px;
      font-size:14px;
      line-height:1.6;
      color:#475569;
      max-width:680px;
    }
    .sr-meta{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .sr-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .btn-soft{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:10px 16px;
      min-width:148px;
      border-radius:12px;
      border:1px solid var(--slate-300);
      background:linear-gradient(180deg,#ffffff,#f8fafc);
      color:#111827;
      font-size:14px;
      font-weight:700;
      text-decoration:none;
    }
    .btn-soft:hover{ box-shadow:0 8px 16px rgba(15,23,42,0.09); }
    .btn-brand{
      border-color:#1d4ed8;
      background:linear-gradient(180deg,#2563eb,#1d4ed8);
      color:#fff;
    }

    .sr-card{
      background:#fff;
      border-radius:16px;
      border:1px solid var(--slate-200);
      padding:18px 20px 20px;
      box-shadow:0 8px 20px rgba(15,23,42,0.06);
      margin-bottom:18px;
    }
    .sr-card-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:10px;
      gap:10px;
      flex-wrap:wrap;
    }
    .sr-card-title{
      font-size:18px;
      font-weight:800;
      color:var(--slate-900);
    }
    .sr-card-sub{
      font-size:13px;
      color:var(--slate-500);
    }
    .stock-badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:90px;
      padding:4px 10px;
      border-radius:999px;
      font-weight:800;
      font-size:12px;
      border:1px solid var(--slate-200);
      color:var(--slate-700);
      background:#fff;
    }
    .stock-badge.pos{
      border-color:#86efac;
      color:var(--ok);
      background:var(--ok-soft);
    }
    .stock-badge.zero{
      border-color:#fdba74;
      color:var(--warn);
      background:var(--warn-soft);
    }
    .stock-search{
      width:320px;
      max-width:100%;
      padding:9px 12px;
      border-radius:10px;
      border:1px solid var(--slate-300);
      background:#fff;
      font-size:14px;
      color:var(--slate-900);
    }
    .stock-search:focus{
      outline:3px solid rgba(37,99,235,0.15);
      border-color:#93c5fd;
    }
    .stock-filter{
      padding:9px 12px;
      border-radius:10px;
      border:1px solid var(--slate-300);
      background:#fff;
      font-size:14px;
      color:var(--slate-900);
    }
  </style>

  {# ---------- Top Bar (Title + Buttons) ---------- #}
  <div class="sr-hero">
    <div style="min-width:260px;">
      <h1>
        üì¶ Stock Report
      </h1>
      <p>
        Current quantity in stock for each product, based on <strong>posted</strong> purchases and sales
        <strong>+ posted stock adjustments</strong>.
      </p>
      <div class="sr-meta">
        <div class="pill">
        <span style="color:#6b7280;">Products:</span>
        <strong>{{ rows|length }}</strong>
        </div>
        <div class="pill">
          <span style="color:#6b7280;">Mode:</span>
          <strong>Posted Entries</strong>
        </div>
      </div>
    </div>

    <div class="sr-actions">
      <a href="{% url 'dashboard' %}"
         class="btn-soft">
        ‚Üê Dashboard
      </a>
      <a href="{% url 'product_list' %}"
         class="btn-soft btn-brand">
        üßæ Products
      </a>
    </div>
  </div>

  {# ---------- Stock Chart Card ---------- #}
  <div class="sr-card card-pad">

    <div class="sr-card-head">
      <div class="sr-card-title">
        Current stock by product
      </div>
      <div class="sr-card-sub">
        Quantities in base units.
      </div>
    </div>

    {% if rows %}
      <p style="font-size:14px;color:#6b7280;margin:0 0 12px;">
        Tip: On mobile, rotate to landscape for easier viewing.
      </p>
      <div class="chart-wrap">
        <div class="chart-box">
          <canvas id="stockChart"></canvas>
        </div>
      </div>
    {% else %}
      <div style="padding:12px 12px;border-radius:12px;border:1px dashed #d1d5db;background:#f9fafb;color:#6b7280;font-size:14px;">
        No products found, so chart is not available.
      </div>
    {% endif %}
  </div>

  {# ---------- Stock Table Card ---------- #}
  <div class="sr-card card-pad">

    <div class="sr-card-head">
      <div class="sr-card-title">
        Product-wise stock position
      </div>
      <div class="sr-card-sub">
        Values shown in product‚Äôs base unit.
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-left:auto;">
        <input type="text" id="stockSearch" class="stock-search" placeholder="Search by code or product name">
        <select id="stockFilter" class="stock-filter" aria-label="Stock filter">
          <option value="all">All stock</option>
          <option value="positive">Positive stock only</option>
          <option value="nonpositive">Zero/negative only</option>
        </select>
      </div>
    </div>

    <div style="width:100%;overflow-x:auto;">
      <table class="tbl">
        <colgroup>
          <col style="width:10%;">
          <col style="width:26%;">
          <col style="width:10%;">
          <col style="width:14%;">
          <col style="width:14%;">
          <col style="width:12%;">
          <col style="width:12%;">
          <col style="width:12%;">
        </colgroup>
        <thead>
          <tr>
            <th class="nowrap">Code</th>
            <th>Product</th>
            <th class="nowrap">Unit</th>
            <th class="right nowrap">Purchase Price</th>
            <th class="right nowrap">Sale Price</th>
            <th class="right nowrap">Base Stock</th>
            <th class="right nowrap">Adj (+/-)</th>
            <th class="right nowrap">Current Stock</th>
          </tr>
        </thead>

        <tbody>
          {% for r in rows %}
            <tr class="stock-row" data-final-stock="{{ r.final_stock|floatformat:3 }}">
              <td class="nowrap">{{ r.product.code }}</td>
              <td class="truncate" title="{{ r.product.name }}">{{ r.product.name }}</td>
              <td class="nowrap">{{ r.product.get_unit_display }}</td>

              <td class="right nowrap">{{ r.product.purchase_price_per_unit|floatformat:2 }}</td>
              <td class="right nowrap">{{ r.product.sale_price_per_unit|floatformat:2 }}</td>

              <td class="right nowrap">{{ r.base_stock|floatformat:3 }}</td>
              <td class="right nowrap">{{ r.net_adj|floatformat:3 }}</td>

              <td class="right nowrap">
                <span class="stock-badge {% if r.final_stock > 0 %}pos{% else %}zero{% endif %}">{{ r.final_stock|floatformat:3 }}</span>
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="8" style="padding:12px 10px;color:#6b7280;text-align:center;">
                No products found.
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </div>
</div>

{# ---------- Stock Chart Data (JSON, VSCode-safe) ---------- #}
{% if rows %}
<script type="application/json" id="stockLabelsJson">
[
  {% for r in rows %}
    "{{ r.product.code|escapejs }} ‚Äì {{ r.product.name|escapejs }}"{% if not forloop.last %},{% endif %}
  {% endfor %}
]
</script>

<script type="application/json" id="stockQtyJson">
[
  {% for r in rows %}
    {{ r.final_stock|floatformat:3 }}{% if not forloop.last %},{% endif %}
  {% endfor %}
]
</script>
{% endif %}

{# ---------- Stock Chart JS ---------- #}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  (function () {
    const input = document.getElementById("stockSearch");
    const filter = document.getElementById("stockFilter");
    if (!input || !filter) return;
    const rows = Array.from(document.querySelectorAll(".stock-row"));
    function applyFilters() {
      const q = (input.value || "").trim().toLowerCase();
      const mode = filter.value || "all";
      rows.forEach((row) => {
        const text = row.textContent.toLowerCase();
        const stockVal = Number(row.getAttribute("data-final-stock") || "0");
        const matchesText = !q || text.includes(q);
        let matchesStock = true;
        if (mode === "positive") matchesStock = stockVal > 0;
        if (mode === "nonpositive") matchesStock = stockVal <= 0;
        row.style.display = (matchesText && matchesStock) ? "" : "none";
      });
    }
    input.addEventListener("input", applyFilters);
    filter.addEventListener("change", applyFilters);
  })();

  (function () {
    const canvas = document.getElementById('stockChart');
    if (!canvas) return;

    const labelsEl = document.getElementById('stockLabelsJson');
    const qtyEl = document.getElementById('stockQtyJson');
    if (!labelsEl || !qtyEl) return;

    let labels = [];
    let quantities = [];
    try {
      labels = JSON.parse(labelsEl.textContent || "[]");
      quantities = JSON.parse(qtyEl.textContent || "[]");
    } catch (e) {
      return;
    }

    if (!labels.length) return;

    // Grow chart height if many bars
    const maxBarsBeforeGrow = 12;
    const base = 260;
    const per = 20;
    const desired = labels.length > maxBarsBeforeGrow ? (base + (labels.length - maxBarsBeforeGrow) * per) : base;

    const box = canvas.parentElement;
    if (box) box.style.height = desired + 'px';

    new Chart(canvas, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Current Stock (base units)',
          data: quantities,
          borderWidth: 1
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,

        // ‚úÖ Remove the forced empty padding
        // layout: { padding: { left: 180 } },

        scales: {
          x: {
            beginAtZero: true,
            ticks: {
              callback: function (value) {
                return Number(value).toLocaleString('en-PK');
              }
            }
          },
          y: {
            ticks: {
              autoSkip: false,
              font: { size: 12 },

              // ‚úÖ This is the correct way: reserve space for long labels
              padding: 6,
            }
          }
        },

        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function (context) {
                const v = context.parsed.x || 0;
                return 'Stock: ' + Number(v).toLocaleString('en-PK', {
                  minimumFractionDigits: 3,
                  maximumFractionDigits: 3
                });
              }
            }
          }
        }
      }
    });
  })();
</script>
{% endblock %}
