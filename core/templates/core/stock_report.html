{% extends "core/base.html" %}

{% block title %}Stock Report{% endblock %}

{% block content %}
<div class="page stock-page" style="max-width:1100px;margin:40px auto 60px;padding:0 26px;">

  <style>
    /* Mobile-friendly page padding */
    @media (max-width: 640px){
      .stock-page{ padding:0 14px !important; margin:24px auto 40px !important; }
      .stock-page h1{ font-size:24px !important; }
      .stock-page p{ font-size:14px !important; }
    }

    /* Consistent table style */
    .tbl{
      width:100%;
      border-collapse:collapse;
      table-layout:fixed;
      min-width:980px;
    }
    .tbl th, .tbl td{
      border-bottom:1px solid #e5e7eb;
      padding:8px 10px;
      font-size:14px;
      vertical-align:middle;
    }
    .tbl th{
      background:#f9fafb;
      font-weight:700;
      text-align:left;
    }
    .right{ text-align:right; }
    .nowrap{ white-space:nowrap; }
    .truncate{
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    /* Card spacing small screens */
    @media (max-width: 640px){
      .card-pad{ padding:14px 14px 16px !important; }
    }

    /* Chart wrapper */
    .chart-wrap{
      width:100%;
      overflow:hidden;
    }
    .chart-box{
      width:100%;
      max-width:100%;
      height:320px;
    }
    @media (max-width: 640px){
      .chart-box{ height:280px; }
    }

    /* Small badge/pill */
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid #e5e7eb;
      background:#fff;
      color:#111827;
      white-space:nowrap;
    }
  </style>

  {# ---------- Top Bar (Title + Buttons) ---------- #}
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;flex-wrap:wrap;gap:12px;">
    <div style="min-width:260px;">
      <h1 style="margin:0 0 4px;font-size:32px;font-weight:800;">
        üì¶ Stock Report
      </h1>
      <p style="margin:0 0 18px;font-size:15px;color:#475569;line-height:1.5;">
        Current quantity in stock for each product, based on <strong>posted</strong> purchases and sales
        <strong>+ posted stock adjustments</strong>.
      </p>
      <div class="pill">
        <span style="color:#6b7280;">Products:</span>
        <strong>{{ rows|length }}</strong>
      </div>
    </div>

    <div style="display:flex;gap:10px;flex-wrap:wrap;">
      <a href="{% url 'dashboard' %}"
         class="btn btn-secondary"
         style="display:inline-flex;align-items:center;justify-content:center;padding:10px 18px;min-width:150px;border-radius:999px;font-size:15px;font-weight:600;text-decoration:none;border:1px solid #d1d5db;cursor:pointer;white-space:nowrap;background:#f3f4f6;color:#111827;">
        ‚Üê Dashboard
      </a>
      <a href="{% url 'product_list' %}"
         class="btn btn-primary"
         style="display:inline-flex;align-items:center;justify-content:center;padding:10px 18px;min-width:170px;border-radius:999px;font-size:15px;font-weight:600;text-decoration:none;border:1px solid #0d6efd;background:#0d6efd;color:#ffffff;cursor:pointer;white-space:nowrap;">
        üßæ Products
      </a>
    </div>
  </div>

  {# ---------- Stock Chart Card ---------- #}
  <div style="background:#ffffff;border-radius:14px;border:1px solid #d1d5db;
              padding:18px 20px 20px;box-shadow:0 6px 18px rgba(15,23,42,0.06);
              margin-bottom:18px;" class="card-pad">

    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;gap:10px;flex-wrap:wrap;">
      <div style="font-size:18px;font-weight:800;">
        Current stock by product
      </div>
      <div style="font-size:13px;color:#6b7280;">
        Quantities in base units.
      </div>
    </div>

    {% if rows %}
      <p style="font-size:14px;color:#6b7280;margin:0 0 12px;">
        Tip: On mobile, rotate to landscape for easier viewing.
      </p>
      <div class="chart-wrap">
        <div class="chart-box">
          <canvas id="stockChart"></canvas>
        </div>
      </div>
    {% else %}
      <div style="padding:12px 12px;border-radius:12px;border:1px dashed #d1d5db;background:#f9fafb;color:#6b7280;font-size:14px;">
        No products found, so chart is not available.
      </div>
    {% endif %}
  </div>

  {# ---------- Stock Table Card ---------- #}
  <div style="background:#ffffff;border-radius:14px;border:1px solid #d1d5db;
              padding:18px 20px 20px;box-shadow:0 6px 18px rgba(15,23,42,0.06);" class="card-pad">

    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;flex-wrap:wrap;gap:10px;">
      <div style="font-size:18px;font-weight:800;">
        Product-wise stock position
      </div>
      <div style="font-size:13px;color:#6b7280;">
        Values shown in product‚Äôs base unit.
      </div>
    </div>

    <div style="width:100%;overflow-x:auto;">
      <table class="tbl">
        <colgroup>
          <col style="width:10%;">
          <col style="width:26%;">
          <col style="width:10%;">
          <col style="width:14%;">
          <col style="width:14%;">
          <col style="width:12%;">
          <col style="width:12%;">
          <col style="width:12%;">
        </colgroup>
        <thead>
          <tr>
            <th class="nowrap">Code</th>
            <th>Product</th>
            <th class="nowrap">Unit</th>
            <th class="right nowrap">Purchase Price</th>
            <th class="right nowrap">Sale Price</th>
            <th class="right nowrap">Base Stock</th>
            <th class="right nowrap">Adj (+/-)</th>
            <th class="right nowrap">Current Stock</th>
          </tr>
        </thead>

        <tbody>
          {% for r in rows %}
            <tr>
              <td class="nowrap">{{ r.product.code }}</td>
              <td class="truncate" title="{{ r.product.name }}">{{ r.product.name }}</td>
              <td class="nowrap">{{ r.product.get_unit_display }}</td>

              <td class="right nowrap">{{ r.product.purchase_price_per_unit|floatformat:2 }}</td>
              <td class="right nowrap">{{ r.product.sale_price_per_unit|floatformat:2 }}</td>

              <td class="right nowrap">{{ r.base_stock|floatformat:3 }}</td>
              <td class="right nowrap">{{ r.net_adj|floatformat:3 }}</td>

              <td class="right nowrap" style="font-weight:900;color:#111827;">
                {{ r.final_stock|floatformat:3 }}
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="8" style="padding:12px 10px;color:#6b7280;text-align:center;">
                No products found.
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </div>
</div>

{# ---------- Stock Chart Data (JSON, VSCode-safe) ---------- #}
{% if rows %}
<script type="application/json" id="stockLabelsJson">
[
  {% for r in rows %}
    "{{ r.product.code|escapejs }} ‚Äì {{ r.product.name|escapejs }}"{% if not forloop.last %},{% endif %}
  {% endfor %}
]
</script>

<script type="application/json" id="stockQtyJson">
[
  {% for r in rows %}
    {{ r.final_stock|floatformat:3 }}{% if not forloop.last %},{% endif %}
  {% endfor %}
]
</script>
{% endif %}

{# ---------- Stock Chart JS ---------- #}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  (function () {
    const canvas = document.getElementById('stockChart');
    if (!canvas) return;

    const labelsEl = document.getElementById('stockLabelsJson');
    const qtyEl = document.getElementById('stockQtyJson');
    if (!labelsEl || !qtyEl) return;

    let labels = [];
    let quantities = [];
    try {
      labels = JSON.parse(labelsEl.textContent || "[]");
      quantities = JSON.parse(qtyEl.textContent || "[]");
    } catch (e) {
      return;
    }

    if (!labels.length) return;

    // Grow chart height if many bars
    const maxBarsBeforeGrow = 12;
    const base = 260;
    const per = 20;
    const desired = labels.length > maxBarsBeforeGrow ? (base + (labels.length - maxBarsBeforeGrow) * per) : base;

    const box = canvas.parentElement;
    if (box) box.style.height = desired + 'px';

    new Chart(canvas, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Current Stock (base units)',
          data: quantities,
          borderWidth: 1
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            beginAtZero: true,
            ticks: {
              callback: function (value) {
                return Number(value).toLocaleString('en-PK');
              }
            }
          },
          y: {
            ticks: { autoSkip: true, maxTicksLimit: 18 }
          }
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function (context) {
                const v = context.parsed.x || 0;
                return 'Stock: ' + Number(v).toLocaleString('en-PK', {
                  minimumFractionDigits: 3,
                  maximumFractionDigits: 3
                });
              }
            }
          }
        }
      }
    });
  })();
</script>
{% endblock %}