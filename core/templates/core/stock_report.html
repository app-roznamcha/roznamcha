{% extends "core/base.html" %}

{% block title %}Stock Report{% endblock %}

{% block content %}
<div class="page" style="max-width:1100px;margin:40px auto 60px;padding:0 26px;">

  {# ---------- Top Bar (Title + Buttons) ---------- #}
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;flex-wrap:wrap;gap:12px;">
    <div>
      <h1 style="margin:0 0 4px;font-size:32px;font-weight:700;">
        üì¶ Stock Report
      </h1>
      <p style="margin:0 0 20px;font-size:15px;color:#475569;">
        Current quantity in stock for each product, based on <strong>posted</strong> purchases and sales
        <strong>+ posted stock adjustments</strong>.
      </p>
    </div>
    <div style="display:flex;gap:10px;flex-wrap:wrap;">
      <a href="{% url 'dashboard' %}"
         class="btn btn-secondary"
         style="display:inline-flex;align-items:center;justify-content:center;padding:10px 18px;min-width:150px;border-radius:999px;font-size:16px;font-weight:500;text-decoration:none;border:1px solid #d1d5db;cursor:pointer;white-space:nowrap;background:#f3f4f6;color:#111827;">
        ‚Üê Dashboard
      </a>
      <a href="{% url 'product_list' %}"
         class="btn btn-primary"
         style="display:inline-flex;align-items:center;justify-content:center;padding:10px 18px;min-width:170px;border-radius:999px;font-size:16px;font-weight:500;text-decoration:none;border:1px solid #0d6efd;background:#0d6efd;color:#ffffff;cursor:pointer;white-space:nowrap;">
        üßæ Products
      </a>
    </div>
  </div>

  {# ---------- Stock Chart Card ---------- #}
  <div style="background:#ffffff;border-radius:14px;border:1px solid #d1d5db;
              padding:18px 20px 24px;box-shadow:0 6px 18px rgba(15,23,42,0.06);
              margin-bottom:20px;">

    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;gap:10px;flex-wrap:wrap;">
      <div style="font-size:18px;font-weight:600;">
        Current stock by product
      </div>
      <div style="font-size:13px;color:#6b7280;">
        Quick visual view of quantities in base units.
      </div>
    </div>

    <p style="font-size:14px;color:#6b7280;margin-bottom:14px;">
      Hover over a bar to see the exact quantity.
    </p>

    <div style="width:100%;max-width:900px;">
      <canvas id="stockChart" height="200"></canvas>
    </div>
  </div>

  {# ---------- Stock Table Card ---------- #}
  <div style="background:#ffffff;border-radius:14px;border:1px solid #d1d5db;
              padding:18px 20px 20px;box-shadow:0 6px 18px rgba(15,23,42,0.06);">

    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;flex-wrap:wrap;gap:10px;">
      <div style="font-size:18px;font-weight:600;">
        Product-wise stock position
      </div>
      <div style="font-size:13px;color:#6b7280;">
        Values shown in product‚Äôs base unit (e.g., KG, Bag, Litre, Unit).
      </div>
    </div>

    <div style="width:100%;overflow-x:auto;">
      <table style="border-collapse:collapse;width:100%;min-width:860px;">
        <thead>
          <tr>
            <th style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;background:#f9fafb;text-align:left;font-weight:600;width:10%;">Code</th>
            <th style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;background:#f9fafb;text-align:left;font-weight:600;">Product</th>
            <th style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;background:#f9fafb;text-align:left;font-weight:600;width:10%;">Unit</th>
            <th style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;background:#f9fafb;text-align:right;font-weight:600;width:15%;">Purchase Price</th>
            <th style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;background:#f9fafb;text-align:right;font-weight:600;width:15%;">Sale Price</th>

            {# Optional breakdown columns (helps debugging) #}
            <th style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;background:#f9fafb;text-align:right;font-weight:600;width:15%;">Base Stock</th>
            <th style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;background:#f9fafb;text-align:right;font-weight:600;width:15%;">Adj (+/-)</th>

            <th style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;background:#f9fafb;text-align:right;font-weight:600;width:15%;">Current Stock</th>
          </tr>
        </thead>

        <tbody>
          {% for r in rows %}
            <tr>
              <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;">
                {{ r.product.code }}
              </td>
              <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;">
                {{ r.product.name }}
              </td>
              <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;">
                {{ r.product.get_unit_display }}
              </td>
              <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:right;">
                {{ r.product.purchase_price_per_unit|floatformat:2 }}
              </td>
              <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:right;">
                {{ r.product.sale_price_per_unit|floatformat:2 }}
              </td>

              <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:right;">
                {{ r.base_stock|floatformat:3 }}
              </td>
              <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:right;">
                {{ r.net_adj|floatformat:3 }}
              </td>

              <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:right;font-weight:700;">
                {{ r.final_stock|floatformat:3 }}
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="8"
                  style="border-bottom:1px solid #e5e7eb;padding:10px 9px;font-size:15px;color:#6b7280;">
                No products found.
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{# ---------- Stock Chart JS ---------- #}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  (function () {
    const labels = [
      {% for r in rows %}
        "{{ r.product.code|escapejs }} ‚Äì {{ r.product.name|escapejs }}"{% if not forloop.last %},{% endif %}
      {% endfor %}
    ];

    const quantities = [
      {% for r in rows %}
        parseFloat("{{ r.final_stock|floatformat:3 }}") || 0{% if not forloop.last %},{% endif %}
      {% endfor %}
    ];

    const canvas = document.getElementById('stockChart');
    if (!canvas || labels.length === 0) return;

    // Make the chart taller if there are many products
    const rowHeight = 18; // px per bar
    const baseHeight = 160;
    canvas.height = Math.max(baseHeight, labels.length * rowHeight);

    const ctx = canvas.getContext('2d');

    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Current Stock (base units)',
          data: quantities,
          borderWidth: 1
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            beginAtZero: true,
            ticks: {
              callback: function (value) {
                return value.toLocaleString('en-PK');
              }
            }
          }
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function (context) {
                const v = context.parsed.x || 0;
                return 'Stock: ' + v.toLocaleString('en-PK', {
                  minimumFractionDigits: 3,
                  maximumFractionDigits: 3
                });
              }
            }
          }
        }
      }
    });
  })();
</script>
{% endblock %}