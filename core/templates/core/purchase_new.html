{% extends "core/base.html" %}
{% block title %}
  {% if edit_mode %}<span data-i18n="edit_purchase_title">Edit Purchase</span>{% else %}<span data-i18n="new_purchase_title">New Purchase</span>{% endif %}
{% endblock %}

{% block content %}
<div class="page purchase-new-page">
  <style>
    .purchase-new-page{
      max-width:1120px;
      margin:34px auto 64px;
      padding:0 18px;
      --line:#e2e8f0;
      --ink-900:#0f172a;
      --ink-700:#334155;
      --primary:#2563eb;
      --primary-dark:#1d4ed8;
      --surface:#ffffff;
    }

    .pn-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      margin-bottom:18px;
      flex-wrap:wrap;
      gap:12px;
      border:1px solid var(--line);
      border-radius:18px;
      padding:18px 20px;
      background:
        radial-gradient(900px 260px at -20% -120%, #dbeafe 0%, transparent 58%),
        radial-gradient(700px 220px at 120% -110%, #dcfce7 0%, transparent 56%),
        var(--surface);
      box-shadow:0 10px 24px rgba(15,23,42,.07);
    }

    .pn-title{
      margin:0 0 4px;
      font-size:31px;
      font-weight:800;
      letter-spacing:-.02em;
      color:var(--ink-900);
    }

    .pn-sub{
      margin:0;
      font-size:15px;
      color:#475569;
      line-height:1.55;
      max-width:720px;
    }

    .pn-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .pn-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:10px 16px;
      min-width:150px;
      border-radius:12px;
      font-size:14px;
      font-weight:700;
      text-decoration:none;
      border:1px solid #cbd5e1;
      background:#f8fafc;
      color:#111827;
      white-space:nowrap;
      transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease;
      cursor:pointer;
    }

    .pn-btn:hover{
      transform:translateY(-1px);
      border-color:#94a3b8;
      box-shadow:0 8px 16px rgba(15,23,42,.08);
    }

    .pn-btn-primary{
      border-color:var(--primary-dark);
      background:linear-gradient(180deg,var(--primary),var(--primary-dark));
      color:#fff;
    }

    .pn-card{
      background:#fff;
      border-radius:16px;
      border:1px solid var(--line);
      padding:18px 20px 20px;
      box-shadow:0 8px 18px rgba(15,23,42,.06);
      margin-bottom:18px;
    }

    .pn-card-title{
      font-size:18px;
      font-weight:800;
      margin-bottom:10px;
      color:#0f172a;
    }

    .purchase-new-page input,
    .purchase-new-page select,
    .purchase-new-page textarea{
      border-color:#cbd5e1 !important;
      border-radius:10px !important;
      padding:8px 10px !important;
      font-size:14px !important;
      transition:border-color .14s ease, box-shadow .14s ease;
    }

    .purchase-new-page input:focus,
    .purchase-new-page select:focus,
    .purchase-new-page textarea:focus{
      border-color:#93c5fd !important;
      box-shadow:0 0 0 3px rgba(37,99,235,.15);
      outline:none;
    }

    .items-top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:10px;
      flex-wrap:wrap;
      gap:10px;
    }

    .items-stats{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }

    .items-chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      border:1px solid #e2e8f0;
      background:#f8fafc;
      color:#0f172a;
      font-size:13px;
      font-weight:700;
      border-radius:999px;
      padding:6px 10px;
    }

    .items-chip.total{
      border-color:#bfdbfe;
      background:#eff6ff;
      color:#1d4ed8;
    }

    .table-wrap{
      border:1px solid #e5e7eb;
      border-radius:12px;
      overflow:auto;
      background:#fff;
      margin-bottom:10px !important;
    }

    #items-table th{
      position:sticky;
      top:0;
      z-index:1;
      background:#f8fafc !important;
      color:#334155;
      text-transform:uppercase;
      letter-spacing:.05em;
      font-size:12px !important;
      font-weight:700 !important;
    }

    #items-table tbody tr:hover{ background:#f8fbff; }

    .items-actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:10px;
    }

    .items-note{
      margin-left:auto;
      color:#64748b;
      font-size:12px;
    }

    .pay-radios{
      display:flex;
      flex-wrap:wrap;
      gap:16px;
      margin-bottom:12px;
      font-size:14px;
      padding:10px 12px;
      border:1px solid #e2e8f0;
      border-radius:10px;
      background:#f8fafc;
    }

    .form-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .pn-link-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:9px 14px;
      border-radius:12px;
      font-size:14px;
      font-weight:700;
      text-decoration:none;
      color:#1d4ed8;
      border:1px solid #dbeafe;
      background:#eff6ff;
    }

    @media (max-width: 700px){
      .purchase-new-page{
        margin:22px auto 52px;
        padding:0 14px;
      }
      .pn-header{ padding:16px; }
      .pn-title{ font-size:25px; }
      .pn-btn,.pn-link-btn{ width:100%; }
      .items-note{ margin-left:0; width:100%; }
    }
  </style>

  {# ---------- Top Bar (Title + Buttons) ---------- #}
<div class="pn-header">
  <div>
    <h1 class="pn-title">
      {% if edit_mode %}
      <span data-i18n="edit_purchase_prefix">Edit Purchase #</span>{{ invoice.invoice_number }}
      {% else %}
        <span data-i18n="new_purchase_title">New Purchase</span>
      {% endif %}
    </h1>
    <p class="pn-sub">
      {% if edit_mode %}
        <span data-i18n="edit_purchase_subtitle">Update this purchase invoice, adjust items, and payment details.</span>
      {% else %}
        <span data-i18n="new_purchase_subtitle">Create a new purchase invoice, add items, and record payment details.</span>
      {% endif %}
    </p>
  </div>

  <div class="pn-actions">
    <a href="{% url 'dashboard' %}" class="pn-btn">
      <span data-i18n="back_dashboard">â† Dashboard</span>
    </a>
    <a href="{% url 'purchase_list' %}" class="pn-btn pn-btn-primary">
      <span data-i18n="purchase_list_btn">ğŸ“„ Purchase List</span>
    </a>
  </div>
</div>
  {# ---------- Error (if any) ---------- #}
  {% if error %}
    <div style="margin-bottom:16px;padding:10px 12px;border-radius:10px;
                font-size:14px;background:#fee2e2;color:#b91c1c;border:1px solid #fecaca;">
      {{ error }}
    </div>
  {% endif %}

  <form method="post">
    {% csrf_token %}

    {# ---------- Supplier & Invoice Details Card ---------- #}
    <div class="pn-card">
      <div class="pn-card-title" data-i18n="supplier_invoice_details">
        Supplier &amp; Invoice Details
      </div>

      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px;">
        <label style="font-size:14px;display:flex;flex-direction:column;gap:4px;">
          <span data-i18n="supplier">Supplier</span>
          <select name="supplier" required
          style="padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;">
            <option value="" data-i18n="select_supplier">-- Select Supplier --</option>
            {% for s in suppliers %}
              <option value="{{ s.id }}"
                      {% if edit_mode and invoice.supplier_id|stringformat:"s" == s.id|stringformat:"s" %}
                        selected
                      {% endif %}>
                {{ s.name }}
              </option>
            {% endfor %}
          </select>
        </label>

        <label style="font-size:14px;display:flex;flex-direction:column;gap:4px;">
          <span data-i18n="invoice_date">Invoice Date</span>
          <input type="date"
            name="invoice_date"
            value="{% if edit_mode %}{{ invoice.invoice_date|date:'Y-m-d' }}{% else %}{{ today }}{% endif %}"
            style="padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;">
        </label>

        <label style="font-size:14px;display:flex;flex-direction:column;gap:4px;">
          <span data-i18n="supplier_invoice_no">Supplier Invoice #</span>
          <input type="text"
            name="invoice_number"
            value="{% if edit_mode %}{{ invoice.invoice_number }}{% else %}{{ suggested_invoice_number }}{% endif %}"
            readonly
            style="padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;background:#f9fafb;">
        </label>

        <div></div> {# keep grid balanced #}
      </div>
    </div>

    {# ---------- Charges Card ---------- #}
    <div class="pn-card">
      <div class="pn-card-title" data-i18n="charges">
        Charges
      </div>

      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px;">
        <label style="font-size:14px;display:flex;flex-direction:column;gap:4px;">
          <span data-i18n="freight_charges">Freight Charges</span>
          <input type="number"
                step="0.01"
                name="freight_charges"
                value="{% if edit_mode %}{{ invoice.freight_charges }}{% else %}0{% endif %}"
                id="freight-input"
                 style="padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;">
        </label>

        <label style="font-size:14px;display:flex;flex-direction:column;gap:4px;">
          <span data-i18n="other_charges">Other Charges</span>
          <input type="number"
          step="0.01"
          name="other_charges"
          value="{% if edit_mode %}{{ invoice.other_charges }}{% else %}0{% endif %}"
          id="other-input"
                 style="padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;">
        </label>
      </div>

      <label style="margin-top:12px;display:block;font-size:14px;">
        <span style="display:block;margin-bottom:4px;" data-i18n="notes">Notes</span>
        <textarea name="notes"
        rows="2"
        style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;resize:vertical;">{% if edit_mode %}{{ invoice.notes }}{% endif %}</textarea>
      </label>
    </div>

    {# ---------- Items Card ---------- #}
    <div class="pn-card">
      <div class="items-top">
        <div class="pn-card-title" style="margin-bottom:0;" data-i18n="items">Items</div>
        <div class="items-stats">
          <div class="items-chip"><span data-i18n="lines_label">Lines</span>: <span id="items-line-count">0</span></div>
          <div class="items-chip"><span data-i18n="total_qty_label">Total Qty</span>: <span id="items-total-qty">0.000</span></div>
          <div class="items-chip"><span data-i18n="items_value_label">Items Value</span>: Rs <span id="items-subtotal-amount">0.00</span></div>
          <div id="items-total-display" class="items-chip total">
          <span data-i18n="total_purchase_prefix">Total Purchase: Rs</span> <span id="items-total-amount">0.00</span>
          </div>
        </div>
      </div>

      <div class="table-wrap" style="margin-bottom:10px;">
        <table id="items-table"
                style="border-collapse:collapse;width:100%;min-width:980px;">
          <thead>
            <tr>
              <th style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;background:#f9fafb;text-align:left;font-weight:600;" data-i18n="col_product">Product</th>
              <th style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;background:#f9fafb;text-align:left;font-weight:600;" data-i18n="col_unit">Unit</th>
              <th style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;background:#f9fafb;text-align:right;font-weight:600;" data-i18n="col_available_stock">
                Available Stock
              </th>
              <th style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;background:#f9fafb;text-align:right;font-weight:600;" data-i18n="col_unit_price">Unit Price</th>
              <th style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;background:#f9fafb;text-align:right;font-weight:600;" data-i18n="col_quantity">Quantity</th>
              <th style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;background:#f9fafb;text-align:right;font-weight:600;" data-i18n="col_total_price">Total Price</th>
              <th style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;background:#f9fafb;text-align:center;font-weight:600;"></th>
            </tr>
          </thead>
          <tbody>
            {# --- If editing: show existing items --- #}
            {% if edit_mode %}

              {% for item in items %}
                {% with forloop.counter as idx %}
                <tr data-row-index="{{ idx }}"
                    data-unit-code="{{ item.product.unit }}"
                    data-packing-type="{{ item.product.packing_type|default:'NONE' }}"
                    data-pieces-per-pack="{{ item.product.pieces_per_pack|default:1 }}"
                    data-packing-label="{{ item.product.get_packing_type_display|default:'' }}">

                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;">
                    <select name="product_{{ idx }}"
                            class="product-select"
                            style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;">
                      <option value="" data-i18n="select">-- Select --</option>
                      {% for p in products %}
                        <option
                          value="{{ p.id }}"
                          data-unit="{{ p.unit }}"
                          data-price="{{ p.purchase_price_per_unit|floatformat:2 }}"
                          data-stock="{{ p.current_stock|floatformat:3 }}"
                          data-unit-label="{{ p.get_unit_display }}"
                          data-packing-type="{{ p.packing_type|default:'NONE' }}"
                          data-pieces-per-pack="{{ p.pieces_per_pack|default:1 }}"
                          data-packing-label="{{ p.get_packing_type_display|default:'' }}"
                          {% if p.id == item.product.id %}selected{% endif %}>
                          {{ p.code }} - {{ p.name }}
                        </option>
                      {% endfor %}
                    </select>
                  </td>

                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;">
                    <select name="unit_{{ idx }}"
                            class="unit-select"
                            style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;">
                      <option value="UNIT"
                              {% if item.unit_mode|default:"UNIT" == "UNIT" %}selected{% endif %}>
                        <span data-i18n="base_prefix">Base</span> {{ item.product.get_unit_display }}
                      </option>
                      {% if item.product.packing_type != "NONE" and item.product.pieces_per_pack > 1 %}
                        <option value="PACK"
                                {% if item.unit_mode|default:"UNIT" == "PACK" %}selected{% endif %}>
                          {{ item.product.get_packing_type_display }} ({{ item.product.pieces_per_pack }} Ã— {{ item.product.get_unit_display }})
                        </option>
                      {% endif %}
                    </select>
                  </td>

                  {# âœ… Available Stock column #}
                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:right;white-space:nowrap;">
                    <span class="stock-display" style="font-weight:600;color:#0f172a;">
                      {{ item.product.current_stock|floatformat:3 }} {{ item.product.get_unit_display }}
                    </span>
                  </td>

                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:right;">
                    <input type="number"
                           step="0.01"
                           name="unit_price_{{ idx }}"
                           class="price-input"
                           value="{{ item.unit_price|floatformat:2 }}"
                           style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;text-align:right;">
                  </td>

                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:right;">
                    <input type="number"
                          step="0.001"
                          class="qty-display-input"
                          value="{{ item.quantity_units|floatformat:3 }}"
                          style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;text-align:right;">
                    <input type="hidden"
                          name="quantity_{{ idx }}"
                          class="qty-hidden-input"
                          value="{{ item.quantity_units|floatformat:3 }}">
                  </td>

                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:right;">
                    <span data-i18n="rs_prefix">Rs</span> <span class="line-total">0.00</span>
                  </td>

                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:center;">
                    <button type="button"
                            class="btn btn-sm btn-danger"
                            onclick="removeRow(this)"
                            style="padding:4px 9px;border-radius:999px;font-size:13px;">
                      âœ•
                    </button>
                  </td>
                </tr>
                {% endwith %}
              {% endfor %}

              {# âœ… add extra blank rows for new items (EDIT MODE) #}
              {% for _ in "12" %}
                {% with items|length|add:forloop.counter as idx %}
                <tr data-row-index="{{ idx }}"
                    data-unit-code=""
                    data-packing-type="NONE"
                    data-pieces-per-pack="1"
                    data-packing-label="">
                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;">
                    <select name="product_{{ idx }}"
                            class="product-select"
                            style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;">
                      <option value="" data-i18n="select">-- Select --</option>
                      {% for p in products %}
                        <option
                          value="{{ p.id }}"
                          data-unit="{{ p.unit }}"
                          data-price="{{ p.purchase_price_per_unit|floatformat:2 }}"
                          data-stock="{{ p.current_stock|floatformat:3 }}"
                          data-unit-label="{{ p.get_unit_display }}"
                          data-packing-type="{{ p.packing_type|default:'NONE' }}"
                          data-pieces-per-pack="{{ p.pieces_per_pack|default:1 }}"
                          data-packing-label="{{ p.get_packing_type_display|default:'' }}">
                          {{ p.code }} - {{ p.name }}
                        </option>
                      {% endfor %}
                    </select>
                  </td>

                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;">
                    <select name="unit_{{ idx }}"
                            class="unit-select"
                            style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;">
                      <option value="" data-i18n="select_unit">-- Unit --</option>
                    </select>
                  </td>

                  {# âœ… Stock cell exists (JS will fill it when product selected) #}
                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:right;white-space:nowrap;">
                    <span class="stock-display" style="font-weight:600;color:#0f172a;">â€”</span>
                  </td>

                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:right;">
                    <input type="number"
                           step="0.01"
                           name="unit_price_{{ idx }}"
                           class="price-input"
                           style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;text-align:right;">
                  </td>

                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:right;">
                    <input type="number"
                           step="0.001"
                           class="qty-display-input"
                           placeholder="Qty"
                           style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;text-align:right;"
                           data-i18n-placeholder="qty_ph">
                    <input type="hidden"
                           name="quantity_{{ idx }}"
                           class="qty-hidden-input">
                  </td>

                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:right;">
                    <span data-i18n="rs_prefix">Rs</span> <span class="line-total">0.00</span>
                  </td>

                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:center;">
                    <button type="button"
                            class="btn btn-sm btn-danger"
                            onclick="removeRow(this)"
                            style="padding:4px 9px;border-radius:999px;font-size:13px;">
                      âœ•
                    </button>
                  </td>
                </tr>
                {% endwith %}
              {% endfor %}

            {% else %}

              {# âœ… NEW SALE: 5 blank rows #}
              {% for _ in "12345" %}
                {% with forloop.counter as idx %}
                <tr data-row-index="{{ idx }}"
                    data-unit-code=""
                    data-packing-type="NONE"
                    data-pieces-per-pack="1"
                    data-packing-label="">
                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;">
                    <select name="product_{{ idx }}"
                            class="product-select"
                            style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;">
                      <option value="" data-i18n="select">-- Select --</option>
                      {% for p in products %}
                        <option
                          value="{{ p.id }}"
                          data-unit="{{ p.unit }}"
                          data-price="{{ p.purchase_price_per_unit|floatformat:2 }}"
                          data-stock="{{ p.current_stock|floatformat:3 }}"
                          data-unit-label="{{ p.get_unit_display }}"
                          data-packing-type="{{ p.packing_type|default:'NONE' }}"
                          data-pieces-per-pack="{{ p.pieces_per_pack|default:1 }}"
                          data-packing-label="{{ p.get_packing_type_display|default:'' }}">
                          {{ p.code }} - {{ p.name }}
                        </option>
                      {% endfor %}
                    </select>
                  </td>

                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;">
                    <select name="unit_{{ idx }}"
                            class="unit-select"
                            style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;">
                      <option value="" data-i18n="select_unit">-- Unit --</option>
                    </select>
                  </td>

                  {# âœ… Stock column #}
                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:right;white-space:nowrap;">
                    <span class="stock-display" style="font-weight:600;color:#0f172a;">â€”</span>
                  </td>

                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:right;">
                    <input type="number"
                           step="0.01"
                           name="unit_price_{{ idx }}"
                           class="price-input"
                           style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;text-align:right;">
                  </td>

                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:right;">
                    <input type="number"
                           step="0.001"
                           class="qty-display-input"
                           placeholder="Qty"
                           style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;text-align:right;"
                           data-i18n-placeholder="qty_ph">
                    <input type="hidden"
                           name="quantity_{{ idx }}"
                           class="qty-hidden-input">
                  </td>

                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:right;">
                    <span data-i18n="rs_prefix">Rs</span> <span class="line-total">0.00</span>
                  </td>

                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:center;">
                    <button type="button"
                            class="btn btn-sm btn-danger"
                            onclick="removeRow(this)"
                            style="padding:4px 9px;border-radius:999px;font-size:13px;">
                      âœ•
                    </button>
                  </td>
                </tr>
                {% endwith %}
              {% endfor %}

            {% endif %}
          </tbody>
        </table>
      </div>

      <div class="items-actions">
        <button type="button" class="pn-btn" onclick="addRow()" data-i18n="add_item_row_btn">
          + Add Item Row
        </button>
        <button type="button" class="pn-btn" onclick="removeEmptyRows()" data-i18n="remove_empty_rows_btn">
          Remove Empty Rows
        </button>
        <div class="items-note"><span data-i18n="shortcut_note_prefix">Shortcut:</span> <strong>Alt + =</strong> <span data-i18n="shortcut_note_suffix">adds a row quickly</span></div>
      </div>
    </div>
    {# ---------- END Items Card ---------- #}

    {# ---------- Payment Card ---------- #}
    <div class="pn-card">
      <div class="pn-card-title" style="margin-bottom:8px;" data-i18n="payment">
        Payment
      </div>

      <p style="margin-bottom:8px;font-weight:500;font-size:15px;">
        <span data-i18n="total_purchase_prefix">Total Purchase: Rs</span> <span id="payment-total-amount">0.00</span>
      </p>

      <div class="field-group pay-radios">
   <label>
     <input type="radio" name="payment_type" value="FULL"
            {% if not edit_mode or invoice.payment_type == "FULL" %}checked{% endif %}>
     <span data-i18n="full_payment">Full Payment (Cash/Bank)</span>
   </label>
   <label>
     <input type="radio" name="payment_type" value="PARTIAL"
            {% if edit_mode and invoice.payment_type == "PARTIAL" %}checked{% endif %}>
     <span data-i18n="partial_payment">Partial Payment</span>
   </label>
   <label>
     <input type="radio" name="payment_type" value="CREDIT"
            {% if edit_mode and invoice.payment_type == "CREDIT" %}checked{% endif %}>
     <span data-i18n="credit_payment">Credit (Supplier will be paid later)</span>
   </label>
 </div>

      <div id="payment-extra-fields" style="margin-top:4px;">
        <label style="display:flex;flex-direction:column;gap:4px;font-size:14px;">
          <span data-i18n="amount_paid">Amount Paid</span>
          <input type="number"
          step="0.01"
          name="payment_amount"
          id="payment-amount-input"
          value="{% if edit_mode %}{{ invoice.payment_amount|default_if_none:'0.00' }}{% else %}0.00{% endif %}"
          style="max-width:260px;padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;">
        </label>
        <p class="text-muted" style="margin:4px 0 10px;font-size:13px;color:#6b7280;">
          <span data-i18n="payment_hint_1">For</span> <strong data-i18n="full_payment_strong">Full Payment</strong>
          <span data-i18n="payment_hint_2">this will be auto-filled from Total Purchase and locked.</span>
          <span data-i18n="payment_hint_3">For</span> <strong data-i18n="partial_payment_strong">Partial</strong><span>,</span>
          <span data-i18n="payment_hint_4">you can type a smaller amount.</span>
        </p>

        <label style="display:flex;flex-direction:column;gap:4px;font-size:14px;max-width:320px;">
          <span data-i18n="payment_account">Payment Account</span>
          <select name="payment_account"
          id="payment-account-select"
          style="padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;">
    <option value="" data-i18n="select_cash_bank">-- Select Cash/Bank Account --</option>
    {% for acc in accounts %}
      <option value="{{ acc.id }}"
              {% if edit_mode and invoice.payment_account_id|stringformat:"s" == acc.id|stringformat:"s" %}
                selected
              {% endif %}>
        {{ acc.code }} - {{ acc.name }}
      </option>
    {% endfor %}
  </select>
        </label>
        <p class="text-muted" style="margin-top:4px;font-size:13px;color:#6b7280;" data-i18n="payment_account_required">
          Required for full or partial cash/bank payments.
        </p>
      </div>

      <p id="credit-note"
         class="text-muted"
         style="margin-top:8px;font-size:13px;display:none;color:#6b7280;">
        <span data-i18n="credit_note_1">For</span> <strong data-i18n="credit_strong">CREDIT</strong>
        <span data-i18n="credit_note_2">purchases, no payment is recorded now and the full amount</span>
        <span data-i18n="credit_note_3">will appear as payable to the supplier.</span>
      </p>
    </div>

    {# ---------- Form Actions ---------- #}
    <div class="form-actions">
      <button type="submit"
      class="pn-btn pn-btn-primary">
{% if edit_mode %}
  <span data-i18n="update_purchase_btn">ğŸ’¾ Update Purchase</span>
{% else %}
  <span data-i18n="save_purchase_unposted_btn">ğŸ’¾ Save Purchase (Unposted)</span>
{% endif %}
</button>
      <a href="{% url 'purchase_list' %}"
         class="pn-link-btn">
        <span data-i18n="cancel">Cancel</span>
      </a>
    </div>

  </form>
</div>

{# -------- JS: product meta + totals + payment behaviour -------- #}
<script>
let purchaseRowCounter = 5; // kept, but we compute the real index from DOM when adding rows

const UNIT_LABELS = {
  "BAG": "Bag",
  "KG": "Kilogram",
  "LITRE": "Litre",
  "UNIT": "Unit / Piece"
};

// Helper: format number to 2 decimal places
function fmt(amount) {
  const n = parseFloat(amount || 0) || 0;
  return n.toFixed(2);
}

// Core sync logic for a single row
function syncRow(tr) {
  const productSelect = tr.querySelector('.product-select');
  const unitSelect = tr.querySelector('.unit-select');
  const priceInput = tr.querySelector('.price-input');
  const qtyDisplayInput = tr.querySelector('.qty-display-input');
  const qtyHiddenInput = tr.querySelector('.qty-hidden-input');
  const totalSpan = tr.querySelector('.line-total');

  if (!productSelect || !unitSelect || !priceInput || !qtyDisplayInput || !qtyHiddenInput || !totalSpan) {
    return;
  }

  const price = parseFloat(priceInput.value || 0) || 0;
  const displayQty = parseFloat(qtyDisplayInput.value || 0) || 0;

  const unitMode = unitSelect.value || "UNIT";  // "UNIT" = base unit, "PACK" = carton/bag/container/bundle
  const piecesPerPack = parseFloat(tr.dataset.piecesPerPack || "1") || 1;

  let multiplier = 1;
  if (unitMode === "PACK") {
    multiplier = piecesPerPack;
  }

  const baseQty = displayQty * multiplier;

  // Hidden field gets base units (what backend expects as quantity_X)
  if (baseQty > 0) {
    qtyHiddenInput.value = baseQty.toFixed(3);
  } else {
    qtyHiddenInput.value = "";
  }

  const lineTotal = baseQty * price;
  totalSpan.textContent = fmt(lineTotal);
}
// âœ… NEW: show available stock (same as sale)
function updateStockDisplay(tr) {
  const productSelect = tr.querySelector('.product-select');
  const unitSelect = tr.querySelector('.unit-select');
  const stockEl = tr.querySelector('.stock-display');

  if (!productSelect || !stockEl) return;

  const opt = productSelect.selectedOptions[0];
  if (!opt || !opt.value) {
    stockEl.textContent = "â€”";
    return;
  }

  const baseStock = parseFloat(opt.dataset.stock || "0") || 0;
  const unitLabel = opt.dataset.unitLabel || "";

  const piecesPerPack = parseFloat(tr.dataset.piecesPerPack || "1") || 1;
  const unitMode = (unitSelect && unitSelect.value) ? unitSelect.value : "UNIT";

  // If PACK is selected, show how many PACKs are available (stock/piecesPerPack)
  let displayStock = baseStock;
  let suffix = unitLabel;

  if (unitMode === "PACK" && piecesPerPack > 1) {
    displayStock = baseStock / piecesPerPack;
    suffix = (tr.dataset.packingLabel || "Pack");
  }

  // Keep 3 decimals like stock
  stockEl.textContent = `${displayStock.toFixed(3)} ${suffix}`.trim();
}
// When product changes: set price, packing metadata, and rebuild Unit dropdown
function handleProductChange(selectEl) {
  const tr = selectEl.closest('tr');
  const unitSelect = tr.querySelector('.unit-select');
  const priceInput = tr.querySelector('.price-input');

  const opt = selectEl.selectedOptions[0];

  // Reset row packing metadata
  tr.dataset.unitCode = "";
  tr.dataset.packingType = "NONE";
  tr.dataset.piecesPerPack = "1";
  tr.dataset.packingLabel = "";

  // Reset unit options
  unitSelect.innerHTML = '<option value="">-- Unit --</option>';

  if (opt) {
    const unitCode = opt.dataset.unit || "";
    const basePrice = opt.dataset.price || "";
    const packingType = opt.dataset.packingType || "NONE";
    const piecesPerPack = opt.dataset.piecesPerPack || "1";
    const packingLabel = opt.dataset.packingLabel || "";

    // Store on row for later
    tr.dataset.unitCode = unitCode;
    tr.dataset.packingType = packingType;
    tr.dataset.piecesPerPack = piecesPerPack;
    tr.dataset.packingLabel = packingLabel;

    // Set price per base unit
    priceInput.value = basePrice;

    // Build Unit options
    if (unitCode) {
      const baseLabel = UNIT_LABELS[unitCode] || "Unit";
      const baseOpt = document.createElement('option');
      baseOpt.value = "UNIT";
      baseOpt.textContent = `Base ${baseLabel}`;
      unitSelect.appendChild(baseOpt);
    }

    const ppNum = parseFloat(piecesPerPack || "1") || 1;
    if (packingType !== "NONE" && ppNum > 1) {
      const packOpt = document.createElement('option');
      packOpt.value = "PACK";
      const unitLabel = UNIT_LABELS[unitCode] || "Unit";
      packOpt.textContent = `${packingLabel} (${ppNum} Ã— ${unitLabel})`;
      unitSelect.appendChild(packOpt);
    }

    // Default to base unit
    unitSelect.value = "UNIT";
  }

  // Sync row calculations + stock display
syncRow(tr);
updateStockDisplay(tr);
recalcGrandTotal();
}

// When qty OR price changes
function handleQtyOrPriceChange(inputEl) {
  const tr = inputEl.closest('tr');
  syncRow(tr);
  recalcGrandTotal();
}

// When Unit dropdown (Unit vs Pack) changes
function handleUnitChange(selectEl) {
  const tr = selectEl.closest('tr');
  syncRow(tr);
updateStockDisplay(tr);
recalcGrandTotal();
}

// Attach all events to a row
function attachRowEvents(tr) {
  const productSelect = tr.querySelector('.product-select');
  const priceInput = tr.querySelector('.price-input');
  const qtyDisplayInput = tr.querySelector('.qty-display-input');
  const unitSelect = tr.querySelector('.unit-select');

  if (productSelect) {
    productSelect.addEventListener('change', () => handleProductChange(productSelect));
  }
  if (priceInput) {
    priceInput.addEventListener('input', () => handleQtyOrPriceChange(priceInput));
  }
  if (qtyDisplayInput) {
    qtyDisplayInput.addEventListener('input', () => handleQtyOrPriceChange(qtyDisplayInput));
  }
  if (unitSelect) {
    unitSelect.addEventListener('change', () => handleUnitChange(unitSelect));
  }
}

function recalcGrandTotal() {
  const rows = document.querySelectorAll('#items-table tbody tr');
  let itemsTotal = 0;
  let totalQty = 0;
  let lineCount = 0;

  rows.forEach(tr => {
    const totalSpan = tr.querySelector('.line-total');
    const lineVal = parseFloat((totalSpan && totalSpan.textContent) || 0) || 0;
    itemsTotal += lineVal;

    const product = tr.querySelector('.product-select');
    const qtyHidden = tr.querySelector('.qty-hidden-input');
    const qty = parseFloat((qtyHidden && qtyHidden.value) || 0) || 0;
    if (product && product.value) {
      lineCount += 1;
      totalQty += qty;
    }
  });

  const freight = parseFloat(document.getElementById('freight-input').value || 0) || 0;
  const other = parseFloat(document.getElementById('other-input').value || 0) || 0;

  const grandTotal = itemsTotal + freight + other;

  const subtotalNode = document.getElementById('items-subtotal-amount');
  if (subtotalNode) subtotalNode.textContent = fmt(itemsTotal);
  document.getElementById('items-total-amount').textContent = fmt(grandTotal);
  document.getElementById('payment-total-amount').textContent = fmt(grandTotal);
  const lineNode = document.getElementById('items-line-count');
  const qtyNode = document.getElementById('items-total-qty');
  if (lineNode) lineNode.textContent = String(lineCount);
  if (qtyNode) qtyNode.textContent = (totalQty || 0).toFixed(3);

  updatePaymentAmount(grandTotal);
}

function updatePaymentAmount(grandTotal) {
  const paymentAmountInput = document.getElementById('payment-amount-input');
  const paymentType = getSelectedPaymentType();

  if (paymentType === 'FULL') {
    paymentAmountInput.value = fmt(grandTotal);
    paymentAmountInput.readOnly = true;
  } else if (paymentType === 'PARTIAL') {
    // If currently zero, prefill; otherwise respect user's smaller amount
    if (!paymentAmountInput.value || parseFloat(paymentAmountInput.value) === 0) {
      paymentAmountInput.value = fmt(grandTotal);
    }
    paymentAmountInput.readOnly = false;
  } else { // CREDIT
    paymentAmountInput.value = fmt(0);
    paymentAmountInput.readOnly = true;
  }
}

function getSelectedPaymentType() {
  const radios = document.querySelectorAll('input[name="payment_type"]');
  let val = 'FULL';
  radios.forEach(r => {
    if (r.checked) val = r.value;
  });
  return val;
}

function addRow() {
  const tbody = document.querySelector('#items-table tbody');
  const lastRow = tbody.querySelector('tr:last-child');

  let nextIndex = 1;
  if (lastRow) {
    nextIndex = (parseInt(lastRow.dataset.rowIndex || "0", 10) || 0) + 1;
  }

  const row = document.createElement('tr');
  row.setAttribute('data-row-index', nextIndex);

  // IMPORTANT: keep default packing info on row (so syncRow works)
  row.dataset.unitCode = "";
  row.dataset.packingType = "NONE";
  row.dataset.piecesPerPack = "1";
  row.dataset.packingLabel = "";

  row.innerHTML = `
  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;">
    <select name="product_${nextIndex}" class="product-select"
            style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;">
      <option value="">-- Select --</option>
      {% for p in products %}
        <option
          value="{{ p.id }}"
          data-unit="{{ p.unit }}"
          data-price="{{ p.purchase_price_per_unit|floatformat:2 }}"

          data-stock="{{ p.current_stock|floatformat:3 }}"
          data-unit-label="{{ p.get_unit_display }}"

          data-packing-type="{{ p.packing_type|default:'NONE' }}"
          data-pieces-per-pack="{{ p.pieces_per_pack|default:1 }}"
          data-packing-label="{{ p.get_packing_type_display|default:'' }}"
        >
          {{ p.code }} - {{ p.name }}
        </option>
      {% endfor %}
    </select>
  </td>

  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;">
    <select name="unit_${nextIndex}" class="unit-select"
            style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;">
      <option value="">-- Unit --</option>
    </select>
  </td>

  <!-- âœ… NEW: Stock display cell -->
  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:right;white-space:nowrap;">
    <span class="stock-display" style="font-weight:600;color:#0f172a;">â€”</span>
  </td>

  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:right;">
    <input type="number"
           step="0.01"
           name="unit_price_${nextIndex}"
           class="price-input"
           style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;text-align:right;">
  </td>

  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:right;">
    <input type="number"
           step="0.001"
           class="qty-display-input"
           data-idx="${nextIndex}"
           placeholder="Qty"
           style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;text-align:right;">
    <input type="hidden"
           name="quantity_${nextIndex}"
           class="qty-hidden-input">
  </td>

  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:right;">
    Rs <span class="line-total">0.00</span>
  </td>

  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:center;">
    <button type="button"
            class="btn btn-sm btn-danger"
            onclick="removeRow(this)"
            style="padding:4px 9px;border-radius:999px;font-size:13px;">
      âœ•
    </button>
  </td>
`;

  tbody.appendChild(row);
  attachRowEvents(row);
  syncRow(row);
  updateStockDisplay(row); // âœ… NEW LINE (this is what I meant)
  recalcGrandTotal();
}

function removeRow(btn) {
  const tr = btn.closest('tr');
  tr.parentNode.removeChild(tr);
  recalcGrandTotal();
}

function removeEmptyRows() {
  const rows = Array.from(document.querySelectorAll('#items-table tbody tr'));
  rows.forEach((tr) => {
    const product = tr.querySelector('.product-select');
    const qtyDisplay = tr.querySelector('.qty-display-input');
    const priceInput = tr.querySelector('.price-input');
    const hasProduct = !!(product && product.value);
    const qty = parseFloat((qtyDisplay && qtyDisplay.value) || 0) || 0;
    const price = parseFloat((priceInput && priceInput.value) || 0) || 0;
    if (!hasProduct && qty <= 0 && price <= 0) {
      tr.remove();
    }
  });
  recalcGrandTotal();
}

// ---- Payment section behaviour ----
function updatePaymentVisibility() {
  const type = getSelectedPaymentType();
  const extra = document.getElementById('payment-extra-fields');
  const creditNote = document.getElementById('credit-note');
  const accountSelect = document.getElementById('payment-account-select');

  if (type === 'CREDIT') {
    extra.style.display = 'none';
    creditNote.style.display = 'block';
    if (accountSelect) {
      accountSelect.value = '';
    }
  } else {
    extra.style.display = 'block';
    creditNote.style.display = 'none';
  }

  const currentTotal = parseFloat(document.getElementById('payment-total-amount').textContent || 0) || 0;
  updatePaymentAmount(currentTotal);
}

document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('#items-table tbody tr').forEach(tr => {
    attachRowEvents(tr);
    syncRow(tr);
    updateStockDisplay(tr); // âœ… NEW

  });

  document.getElementById('freight-input').addEventListener('input', recalcGrandTotal);
  document.getElementById('other-input').addEventListener('input', recalcGrandTotal);

  const paymentRadios = document.querySelectorAll('input[name="payment_type"]');
  paymentRadios.forEach(r => r.addEventListener('change', updatePaymentVisibility));

  recalcGrandTotal();
  updatePaymentVisibility();

  document.addEventListener('keydown', function(e) {
    if (e.altKey && e.key === '=') {
      e.preventDefault();
      addRow();
    }
  });
});
</script>

<script>
  // Page dictionary: extend global ROZ_I18N without touching base
  window.ROZ_I18N = window.ROZ_I18N || { en: {}, ur: {} };

  Object.assign(window.ROZ_I18N.en, {
    new_purchase_title: "New Purchase",
    edit_purchase_title: "Edit Purchase",
    edit_purchase_prefix: "Edit Purchase #",
    new_purchase_subtitle: "Create a new purchase invoice, add items, and record payment details.",
    edit_purchase_subtitle: "Update this purchase invoice, adjust items, and payment details.",

    back_dashboard: "â† Dashboard",
    purchase_list_btn: "ğŸ“„ Purchase List",

    supplier_invoice_details: "Supplier & Invoice Details",
    supplier: "Supplier",
    select_supplier: "-- Select Supplier --",
    invoice_date: "Invoice Date",
    supplier_invoice_no: "Supplier Invoice #",

    charges: "Charges",
    freight_charges: "Freight Charges",
    other_charges: "Other Charges",
    notes: "Notes",

    items: "Items",
    total_purchase_prefix: "Total Purchase: Rs",
    col_product: "Product",
    col_unit: "Unit",
    col_available_stock: "Available Stock",
    col_unit_price: "Unit Price",
    col_quantity: "Quantity",
    col_total_price: "Total Price",

    select: "-- Select --",
    select_unit: "-- Unit --",
    add_item_row_btn: "+ Add Item Row",
    remove_empty_rows_btn: "Remove Empty Rows",
    lines_label: "Lines",
    total_qty_label: "Total Qty",
    items_value_label: "Items Value",
    shortcut_note_prefix: "Shortcut:",
    shortcut_note_suffix: "adds a row quickly",
    qty_ph: "Qty",
    rs_prefix: "Rs",
    base_prefix: "Base",

    payment: "Payment",
    full_payment: "Full Payment (Cash/Bank)",
    partial_payment: "Partial Payment",
    credit_payment: "Credit (Supplier will be paid later)",
    amount_paid: "Amount Paid",
    payment_hint_1: "For",
    full_payment_strong: "Full Payment",
    payment_hint_2: "this will be auto-filled from Total Purchase and locked.",
    payment_hint_3: "For",
    partial_payment_strong: "Partial",
    payment_hint_4: "you can type a smaller amount.",
    payment_account: "Payment Account",
    select_cash_bank: "-- Select Cash/Bank Account --",
    payment_account_required: "Required for full or partial cash/bank payments.",
    credit_strong: "CREDIT",
    credit_note_1: "For",
    credit_note_2: "purchases, no payment is recorded now and the full amount",
    credit_note_3: "will appear as payable to the supplier.",

    update_purchase_btn: "ğŸ’¾ Update Purchase",
    save_purchase_unposted_btn: "ğŸ’¾ Save Purchase (Unposted)",
    cancel: "Cancel"
  });

  Object.assign(window.ROZ_I18N.ur, {
    new_purchase_title: "Ù†Ø¦ÛŒ Ø®Ø±ÛŒØ¯",
    edit_purchase_title: "Ø®Ø±ÛŒØ¯ Ù…ÛŒÚº ØªØ±Ù…ÛŒÙ…",
    edit_purchase_prefix: "Ø®Ø±ÛŒØ¯ #",
    new_purchase_subtitle: "Ù†Ø¦ÛŒ Ø®Ø±ÛŒØ¯ Ø§Ù†ÙˆØ§Ø¦Ø³ Ø¨Ù†Ø§Ø¦ÛŒÚºØŒ Ø¢Ø¦Ù¹Ù…Ø² Ø´Ø§Ù…Ù„ Ú©Ø±ÛŒÚº Ø§ÙˆØ± Ø§Ø¯Ø§Ø¦ÛŒÚ¯ÛŒ Ú©ÛŒ ØªÙØµÛŒÙ„ Ø¯Ø±Ø¬ Ú©Ø±ÛŒÚºÛ”",
    edit_purchase_subtitle: "Ø§Ø³ Ø®Ø±ÛŒØ¯ Ø§Ù†ÙˆØ§Ø¦Ø³ Ú©Ùˆ Ø§Ù¾ÚˆÛŒÙ¹ Ú©Ø±ÛŒÚºØŒ Ø¢Ø¦Ù¹Ù…Ø² Ø§ÙˆØ± Ø§Ø¯Ø§Ø¦ÛŒÚ¯ÛŒ Ú©ÛŒ ØªÙØµÛŒÙ„ Ø¯Ø±Ø³Øª Ú©Ø±ÛŒÚºÛ”",

    back_dashboard: "â† ÚˆÛŒØ´ Ø¨ÙˆØ±Úˆ",
    purchase_list_btn: "ğŸ“„ Ø®Ø±ÛŒØ¯ Ú©ÛŒ ÙÛØ±Ø³Øª",

    supplier_invoice_details: "Ø³Ù¾Ù„Ø§Ø¦Ø± Ø§ÙˆØ± Ø§Ù†ÙˆØ§Ø¦Ø³ Ú©ÛŒ ØªÙØµÛŒÙ„",
    supplier: "Ø³Ù¾Ù„Ø§Ø¦Ø±",
    select_supplier: "-- Ø³Ù¾Ù„Ø§Ø¦Ø± Ù…Ù†ØªØ®Ø¨ Ú©Ø±ÛŒÚº --",
    invoice_date: "Ø§Ù†ÙˆØ§Ø¦Ø³ Ú©ÛŒ ØªØ§Ø±ÛŒØ®",
    supplier_invoice_no: "Ø³Ù¾Ù„Ø§Ø¦Ø± Ø§Ù†ÙˆØ§Ø¦Ø³ #",

    charges: "Ú†Ø§Ø±Ø¬Ø²",
    freight_charges: "ÙØ±ÛŒÙ¹ Ú†Ø§Ø±Ø¬Ø²",
    other_charges: "Ø¯ÛŒÚ¯Ø± Ú†Ø§Ø±Ø¬Ø²",
    notes: "Ù†ÙˆÙ¹Ø³",

    items: "Ø¢Ø¦Ù¹Ù…Ø²",
    total_purchase_prefix: "Ú©Ù„ Ø®Ø±ÛŒØ¯: Rs",
    col_product: "Ù¾Ø±ÙˆÚˆÚ©Ù¹",
    col_unit: "ÛŒÙˆÙ†Ù¹",
    col_available_stock: "Ù…ÙˆØ¬ÙˆØ¯Û Ø§Ø³Ù¹Ø§Ú©",
    col_unit_price: "ÙÛŒ ÛŒÙˆÙ†Ù¹ Ù‚ÛŒÙ…Øª",
    col_quantity: "Ù…Ù‚Ø¯Ø§Ø±",
    col_total_price: "Ú©Ù„ Ù‚ÛŒÙ…Øª",

    select: "-- Ù…Ù†ØªØ®Ø¨ Ú©Ø±ÛŒÚº --",
    select_unit: "-- ÛŒÙˆÙ†Ù¹ --",
    add_item_row_btn: "+ Ø¢Ø¦Ù¹Ù… Ø±Ùˆ Ø´Ø§Ù…Ù„ Ú©Ø±ÛŒÚº",
    remove_empty_rows_btn: "Ø®Ø§Ù„ÛŒ Ù‚Ø·Ø§Ø±ÛŒÚº ÛÙ¹Ø§Ø¦ÛŒÚº",
    lines_label: "Ù‚Ø·Ø§Ø±ÛŒÚº",
    total_qty_label: "Ú©Ù„ Ù…Ù‚Ø¯Ø§Ø±",
    items_value_label: "Ø¢Ø¦Ù¹Ù…Ø² ÙˆÛŒÙ„ÛŒÙˆ",
    shortcut_note_prefix: "Ø´Ø§Ø±Ù¹ Ú©Ù¹:",
    shortcut_note_suffix: "Ø¬Ù„Ø¯ÛŒ Ù†Ø¦ÛŒ Ù‚Ø·Ø§Ø± Ø´Ø§Ù…Ù„ Ú©Ø±ÛŒÚº",
    qty_ph: "Ù…Ù‚Ø¯Ø§Ø±",
    rs_prefix: "Rs",
    base_prefix: "Ø¨ÛŒØ³",

    payment: "Ø§Ø¯Ø§Ø¦ÛŒÚ¯ÛŒ",
    full_payment: "Ù…Ú©Ù…Ù„ Ø§Ø¯Ø§Ø¦ÛŒÚ¯ÛŒ (Ú©ÛŒØ´/Ø¨ÛŒÙ†Ú©)",
    partial_payment: "Ø¬Ø²ÙˆÛŒ Ø§Ø¯Ø§Ø¦ÛŒÚ¯ÛŒ",
    credit_payment: "Ø§Ø¯Ú¾Ø§Ø± (Ø³Ù¾Ù„Ø§Ø¦Ø± Ú©Ùˆ Ø¨Ø¹Ø¯ Ù…ÛŒÚº Ø§Ø¯Ø§Ø¦ÛŒÚ¯ÛŒ ÛÙˆÚ¯ÛŒ)",
    amount_paid: "Ø§Ø¯Ø§ Ø´Ø¯Û Ø±Ù‚Ù…",
    payment_hint_1: "",
    full_payment_strong: "Ù…Ú©Ù…Ù„ Ø§Ø¯Ø§Ø¦ÛŒÚ¯ÛŒ",
    payment_hint_2: "Ù…ÛŒÚº ÛŒÛ Ú©Ù„ Ø®Ø±ÛŒØ¯ Ø³Û’ Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ú¾Ø± Ø¬Ø§Ø¦Û’ Ú¯ÛŒ Ø§ÙˆØ± Ù„Ø§Ú© ÛÙˆÚ¯ÛŒÛ”",
    payment_hint_3: "",
    partial_payment_strong: "Ø¬Ø²ÙˆÛŒ",
    payment_hint_4: "Ù…ÛŒÚº Ø¢Ù¾ Ú©Ù… Ø±Ù‚Ù… Ø¯Ø±Ø¬ Ú©Ø± Ø³Ú©ØªÛ’ ÛÛŒÚºÛ”",
    payment_account: "Ø§Ø¯Ø§Ø¦ÛŒÚ¯ÛŒ Ø§Ú©Ø§Ø¤Ù†Ù¹",
    select_cash_bank: "-- Ú©ÛŒØ´/Ø¨ÛŒÙ†Ú© Ø§Ú©Ø§Ø¤Ù†Ù¹ Ù…Ù†ØªØ®Ø¨ Ú©Ø±ÛŒÚº --",
    payment_account_required: "Ù…Ú©Ù…Ù„ ÛŒØ§ Ø¬Ø²ÙˆÛŒ Ú©ÛŒØ´/Ø¨ÛŒÙ†Ú© Ø§Ø¯Ø§Ø¦ÛŒÚ¯ÛŒ Ú©ÛŒÙ„Ø¦Û’ Ø¶Ø±ÙˆØ±ÛŒ ÛÛ’Û”",
    credit_strong: "Ø§Ø¯Ú¾Ø§Ø±",
    credit_note_1: "",
    credit_note_2: "Ø®Ø±ÛŒØ¯ Ù…ÛŒÚº Ø§Ø¨Ú¾ÛŒ Ø§Ø¯Ø§Ø¦ÛŒÚ¯ÛŒ Ø±ÛŒÚ©Ø§Ø±Úˆ Ù†ÛÛŒÚº ÛÙˆØªÛŒ Ø§ÙˆØ± Ù¾ÙˆØ±ÛŒ Ø±Ù‚Ù…",
    credit_note_3: "Ø³Ù¾Ù„Ø§Ø¦Ø± Ú©Û’ Ù‚Ø§Ø¨Ù„Ù Ø§Ø¯Ø§Ø¦ÛŒÚ¯ÛŒ Ù…ÛŒÚº Ø´Ø§Ù…Ù„ ÛÙˆÚ¯ÛŒÛ”",

    update_purchase_btn: "ğŸ’¾ Ø®Ø±ÛŒØ¯ Ø§Ù¾ÚˆÛŒÙ¹ Ú©Ø±ÛŒÚº",
    save_purchase_unposted_btn: "ğŸ’¾ Ø®Ø±ÛŒØ¯ Ù…Ø­ÙÙˆØ¸ Ú©Ø±ÛŒÚº (Ø§Ù† Ù¾ÙˆØ³Ù¹Úˆ)",
    cancel: "Ù…Ù†Ø³ÙˆØ® Ú©Ø±ÛŒÚº"
  });

  // Apply current language to this page after dict is loaded
  if (window.applyLang) window.applyLang(localStorage.getItem("roz_lang") || "en");

  // Optional: translate placeholders on this page (keeps existing logic untouched)
  (function () {
    function applyPlaceholders() {
      const lang = localStorage.getItem("roz_lang") || "en";
      const pack = (window.ROZ_I18N && window.ROZ_I18N[lang]) ? window.ROZ_I18N[lang] : {};
      document.querySelectorAll("[data-i18n-placeholder]").forEach(el => {
        const key = el.getAttribute("data-i18n-placeholder");
        if (pack[key]) el.setAttribute("placeholder", pack[key]);
      });
    }
    applyPlaceholders();
    document.addEventListener("roz:lang-changed", applyPlaceholders);
    window.addEventListener("storage", (e) => { if (e.key === "roz_lang") applyPlaceholders(); });
  })();
</script>

{% endblock %}
