{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>
        Roznamcha ‚Äî Smart Khata & Hisab System
      </title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="description" content="Roznamcha is a smart khata & hisab system for Pakistani businesses. Manage sales, purchases, payments, ledgers, stock and reports in one clean platform.">
    <link rel="canonical" href="https://roznamcha.app{{ request.path }}">

    <meta property="og:title" content="Roznamcha ‚Äî Smart Khata & Hisab System">
    <meta property="og:description" content="Sales, purchases, ledgers, stock, reports ‚Äî fast, clean, accurate accounting for practical business workflows.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://roznamcha.app{{ request.path }}">
    <meta property="og:image" content="https://roznamcha.app{% static 'core/branding/roznamcha.png' %}">

    <meta name="twitter:card" content="summary_large_image">

    <style>
      * { box-sizing: border-box; }
    
      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: #f3f4f6;
        color: #111827;
        -webkit-text-size-adjust: 100%;
      }
    
      a {
        color: #2563eb;
        text-decoration: none;
      }
      a:hover { text-decoration: underline; }
    
      /* Make media responsive everywhere */
      img, video, canvas, svg {
        max-width: 100%;
        height: auto;
      }
    
      /* Prevent iOS zoom on form fields */
      input, select, textarea, button {
        font-size: 16px;
      }
    
      /* Top header bar */
      .app-header {
        background: #ffffff;
        border-bottom: 1px solid #e5e7eb;
      }
    
      .app-header-inner {
        max-width: 1200px;
        margin: 0 auto;
        padding: 14px 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }
    
      .brand {
        display: flex;
        align-items: center;
        gap: 26px;
        min-width: 0;
      }
    
      .brand-logo {
        height: 64px;
        width: auto;
        object-fit: contain;
        border-radius: 12px;
        border: 0;
        background: transparent;
      }
    
      .brand-name {
        font-weight: 800;
        font-size: 16px;
        color: #111827;
        line-height: 1.1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 520px;
      }
    
      .brand-sub {
        font-size: 12px;
        color: #6b7280;
        margin-top: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 520px;
      }
    
      /* Simple container for regular pages. */
      .app-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 24px 16px 40px;
      }
    
      /* Allow certain pages to go full width */
      .app-container.is-fluid {
        max-width: 100%;
        padding-left: 32px;
        padding-right: 32px;
      }
    
      /* Generic primary button */
      .btn-primary {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 8px 16px;
        border-radius: 999px;
        background: #2563eb;
        border: 1px solid #2563eb;
        color: #ffffff;
        font-size: 14px;
        font-weight: 500;
        text-decoration: none;
        cursor: pointer;
        white-space: nowrap;
      }
      .btn-primary:hover {
        background: #1d4ed8;
        border-color: #1d4ed8;
      }
    
      /* Secondary button */
      .btn-secondary {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 8px 16px;
        border-radius: 999px;
        background: #ffffff;
        border: 1px solid #e5e7eb;
        color: #374151;
        font-size: 14px;
        font-weight: 600;
        text-decoration: none;
        cursor: pointer;
        white-space: nowrap;
      }
      .btn-secondary:hover { background: #f3f4f6; }
    
      .header-actions {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: flex-end;
      }
    
      /* Logout button */
      .btn-header-logout {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 8px 16px;
        border-radius: 999px;
        background: #ffffff;
        border: 1px solid #e5e7eb;
        color: #374151;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        white-space: nowrap;
      }
      .btn-header-logout:hover {
        background: #fef2f2;
        border-color: #fecaca;
        color: #b91c1c;
      }
    
      /* ‚úÖ MOBILE: header stacks, logo shrinks, spacing tightens */
      @media (max-width: 640px) {
        .app-header-inner {
          flex-direction: column;
          align-items: stretch;
          gap: 10px;
          padding: 12px 14px;
        }
    
        .brand {
          justify-content: center;
        }
    
        .brand-logo {
          height: 52px;
          border-radius: 10px;
        }
    
        .header-actions {
          justify-content: center;
        }
    
        .app-container {
          padding: 16px 12px 28px;
        }
    
        .app-container.is-fluid {
          padding-left: 14px;
          padding-right: 14px;
        }
      }

      /* =========================
        Responsive helpers
        ========================= */

      /* Make header wrap nicely on small screens */
      @media (max-width: 768px) {
        .app-header-inner {
          flex-wrap: wrap;
          justify-content: center;
          gap: 10px;
        }

        .brand {
          width: 100%;
          justify-content: center;
          gap: 14px;
        }

        .brand-logo {
          height: 52px; /* slightly smaller on mobile */
        }

        .header-actions {
          width: 100%;
          justify-content: center;
        }
      }

      /* Generic card spacing on mobile */
      @media (max-width: 640px) {
        .app-container {
          padding: 16px 12px 30px;
        }
      }

      /* Tables: allow horizontal scroll without breaking layout */
      .table-wrap{
        width:100%;
        overflow-x:auto;
        -webkit-overflow-scrolling: touch;
        border-radius: 14px;
      }
      .table-wrap table{
        min-width: 980px; /* keeps columns readable on phone */
      }
      /* Django messages */
      .msg-wrap{
        max-width:1100px;
        margin:14px auto 0;
        padding:0 14px;
      }
      .msg{
        padding:12px 16px;
        border-radius:12px;
        margin-bottom:10px;
        font-weight:600;
        border:1px solid #e5e7eb;
        background:#f1f5f9;
        color:#0f172a;
      }
      .msg-success{
        background:#ecfdf5;
        color:#065f46;
        border-color:#10b981;
      }
      .msg-error{
        background:#fef2f2;
        color:#991b1b;
        border-color:#ef4444;
      }
      .msg-warning{
        background:#fffbeb;
        color:#92400e;
        border-color:#f59e0b;
      }

      /* Language toggle */
      .lang-toggle{
        display:inline-flex;
        align-items:center;
        gap:6px;
        padding:6px 8px;
        border-radius:999px;
        border:1px solid #e5e7eb;
        background:#fff;
        font-weight:800;
        font-size:13px;
      }

      .lang-toggle button{
        border:none;
        background:transparent;
        cursor:pointer;
        font-weight:900;
        padding:4px 8px;
        border-radius:999px;
      }

      .lang-toggle button.active{
        background:#eff6ff;
        color:#1d4ed8;
      }

      /* RTL support */
      html[dir="rtl"]{
        direction: rtl;
      }

      html[dir="rtl"] body{
        text-align: right;
      }
    </style>

    <!-- PWA -->
    <link rel="manifest" href="{% url 'pwa_manifest' %}">
    <meta name="theme-color" content="#2563eb">

    <!-- iOS (Add to Home Screen) -->
    <link rel="apple-touch-icon" href="{% static 'core/pwa/icons/apple-touch-icon.png' %}">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    {% block extra_head %}{% endblock %}
    
</head>

<body>

    <!-- ‚úÖ Global Header with Company Branding -->
    <header class="app-header">
        <div class="app-header-inner">

            <div class="brand">
                <a href="{% if user.is_authenticated %}{% url 'dashboard' %}{% else %}{% url 'landing' %}{% endif %}"
                    title="Roznamcha"
                    style="display:inline-flex;align-items:center;">
                    <img
                      src="{% static 'core/branding/roznamcha.png' %}"
                      alt="Roznamcha"
                      class="brand-logo"
                    />
                  </a>
            </div>

            <div class="header-actions">
              
              <div class="lang-toggle" style="margin-right:6px;">
                <button type="button" id="btnEN" class="active">EN</button>
                <button type="button" id="btnUR">ÿßÿ±ÿØŸà</button>
              </div>

              <button id="installBtn" class="btn-secondary" type="button" style="display:none;">
                ‚¨áÔ∏è Install App
              </button>
            
              {% if user.is_authenticated %}
                <form method="post" action="{% url 'logout' %}" style="margin:0;">
                  {% csrf_token %}
                  <button type="submit" class="btn-header-logout" title="Logout">‚èª Logout</button>
                </form>
              {% else %}
                <a href="{% url 'login' %}" class="btn-primary">Login</a>
              {% endif %}

            </div>
            
        </div>
    </header>

    <div class="app-container {% block container_class %}{% endblock %} {% block page_class %}{% endblock %}">
      <div id="iosA2HS" style="display:none;max-width:1100px;margin:14px auto 0;padding:10px 14px;border-radius:12px;background:#eff6ff;border:1px solid #bfdbfe;color:#1e40af;font-weight:600;">
        üì± On iPhone: Tap <b>Share</b> (‚¨ÜÔ∏è) then <b>Add to Home Screen</b> to install Roznamcha.
      </div>
      
      <script>
        (function () {
          const isIos = /iphone|ipad|ipod/i.test(navigator.userAgent);
          const isStandalone = window.matchMedia("(display-mode: standalone)").matches || window.navigator.standalone;
          if (isIos && !isStandalone) {
            const bar = document.getElementById("iosA2HS");
            if (bar) bar.style.display = "block";
          }
        })();
      </script>
      {% if request.user.is_authenticated %}
    
        {# ‚úÖ Never show subscription banners to Super Admin #}
        {% with prof=user_profile %}
        {% if request.user.is_superuser or prof.role == "SUPERADMIN" %}
          {# ‚úÖ Never show subscription banners to Super Admin #}
        {% else %}

          {# ‚úÖ Use effective subscription context (works for OWNER + STAFF) #}
          {% if subscription_is_trial %}
            <div style="max-width:1100px;margin:14px auto 0;padding:10px 14px;border-radius:12px;background:#fffbeb;border:1px solid #fde68a;color:#92400e;">
              You are on <b>Trial</b>{% if subscription_days_left != None %} ({{ subscription_days_left }} days left){% endif %}.
              Please activate subscription before trial ends.
              <a href="{% url 'subscription_page' %}" style="margin-left:10px;font-weight:700;color:#92400e;">View</a>
            </div>
          {% elif subscription_is_expired %}
            <div style="max-width:1100px;margin:14px auto 0;padding:10px 14px;border-radius:12px;background:#fff1f2;border:1px solid #fecdd3;color:#9f1239;">
              Your subscription is <b>expired</b>. Some actions are blocked.
              <a href="{% url 'subscription_page' %}" style="margin-left:10px;font-weight:700;color:#9f1239;">Renew</a>
            </div>
          {% endif %}

        {% endif %}
      {% endwith %}
    
      {% endif %}
      
     {% if messages %}
       <div class="msg-wrap">
         {% for message in messages %}
           <div class="msg
             {% if message.tags == 'success' %} msg-success
             {% elif message.tags == 'error' %} msg-error
             {% elif message.tags == 'warning' %} msg-warning
             {% endif %}
           ">
             {{ message }}
           </div>
         {% endfor %}
       </div>
     {% endif %}

      {% block content %}{% endblock %}
    </div>
    <script>
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", function () {
          navigator.serviceWorker.register("{% url 'service_worker' %}")
            .catch(function (err) {
              console.log("SW registration failed:", err);
            });
        });
      }
    </script>
    <script>
      let deferredPrompt = null;
    
      function isStandaloneMode() {
        return window.matchMedia("(display-mode: standalone)").matches || window.navigator.standalone === true;
      }
    
      async function isAppInstalled() {
        // 1) If running as installed app (standalone), it IS installed
        if (isStandaloneMode()) return true;
    
        // 2) Chrome/Edge: detect installed related app (best available check)
        if (navigator.getInstalledRelatedApps) {
          try {
            const related = await navigator.getInstalledRelatedApps();
            // If you later add an id in manifest, you can check it here.
            if (related && related.length > 0) return true;
          } catch (e) {
            // ignore
          }
        }
    
        return false;
      }
    
      async function hideInstallIfInstalled() {
        const btn = document.getElementById("installBtn");
        if (!btn) return;
    
        // Always default hidden
        btn.style.display = "none";
    
        // If installed, keep hidden forever
        const installed = await isAppInstalled();
        if (installed) {
          deferredPrompt = null;
          btn.style.display = "none";
        }
      }
    
      // Run early
      document.addEventListener("DOMContentLoaded", hideInstallIfInstalled);
    
      window.addEventListener("beforeinstallprompt", async (e) => {
        // Only show if NOT installed
        const installed = await isAppInstalled();
        if (installed) return;
    
        e.preventDefault();
        deferredPrompt = e;
    
        const btn = document.getElementById("installBtn");
        if (btn) btn.style.display = "inline-flex";
      });
    
      window.addEventListener("appinstalled", () => {
        deferredPrompt = null;
        const btn = document.getElementById("installBtn");
        if (btn) btn.style.display = "none";
      });
    
      document.addEventListener("click", async (e) => {
        if (!(e.target && e.target.id === "installBtn")) return;
    
        if (!deferredPrompt) return;
    
        deferredPrompt.prompt();
        const choice = await deferredPrompt.userChoice;
        deferredPrompt = null;
    
        const btn = document.getElementById("installBtn");
        if (btn) btn.style.display = "none";
      });
    </script>

    <script>
      window.ROZ_I18N = window.ROZ_I18N || { en: {}, ur: {} };

      window.applyLang = function(lang){
        localStorage.setItem("roz_lang", lang);
        document.documentElement.lang = (lang === "ur") ? "ur" : "en";
        document.documentElement.dir  = (lang === "ur") ? "rtl" : "ltr";

        document.querySelectorAll("[data-i18n]").forEach(el => {
          const key = el.getAttribute("data-i18n");
          const val = (window.ROZ_I18N[lang] || {})[key];
          if (val) el.textContent = val;
        });

        const enBtn = document.getElementById("btnEN");
        const urBtn = document.getElementById("btnUR");
        if (enBtn && urBtn) {
          enBtn.classList.toggle("active", lang === "en");
          urBtn.classList.toggle("active", lang === "ur");
        }
        document.dispatchEvent(new CustomEvent("roz:lang-changed", { detail: { lang } }));

      };

      document.addEventListener("DOMContentLoaded", () => {
        const enBtn = document.getElementById("btnEN");
        const urBtn = document.getElementById("btnUR");
        if (enBtn) enBtn.addEventListener("click", () => window.applyLang("en"));
        if (urBtn) urBtn.addEventListener("click", () => window.applyLang("ur"));
        window.applyLang(localStorage.getItem("roz_lang") || "en");
      });
    </script>
</body>
</html>
