{% extends "core/base.html" %}

{% block content %}
<div class="page returns-new-page">
  <style>
    .returns-new-page{
      max-width:1120px;
      margin:34px auto 64px;
      padding:0 18px;
      --line:#e2e8f0;
      --ink-900:#0f172a;
      --ink-700:#334155;
      --primary:#2563eb;
      --primary-dark:#1d4ed8;
      --surface:#ffffff;
    }

    .rn-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      margin-bottom:18px;
      flex-wrap:wrap;
      gap:12px;
      border:1px solid var(--line);
      border-radius:18px;
      padding:18px 20px;
      background:
        radial-gradient(900px 260px at -20% -120%, #dbeafe 0%, transparent 58%),
        radial-gradient(700px 220px at 120% -110%, #dcfce7 0%, transparent 56%),
        var(--surface);
      box-shadow:0 10px 24px rgba(15,23,42,.07);
    }

    .rn-title{
      margin:0 0 4px;
      font-size:31px;
      font-weight:800;
      color:var(--ink-900);
      letter-spacing:-.02em;
    }

    .rn-sub{
      margin:0;
      font-size:15px;
      color:#475569;
      line-height:1.55;
      max-width:740px;
    }

    .rn-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .rn-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:10px 16px;
      min-width:150px;
      border-radius:12px;
      font-size:14px;
      font-weight:700;
      text-decoration:none;
      border:1px solid #cbd5e1;
      background:#f8fafc;
      color:#111827;
      white-space:nowrap;
      transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease;
      cursor:pointer;
    }

    .rn-btn:hover{
      transform:translateY(-1px);
      border-color:#94a3b8;
      box-shadow:0 8px 16px rgba(15,23,42,.08);
    }

    .rn-btn-primary{
      border-color:var(--primary-dark);
      background:linear-gradient(180deg,var(--primary),var(--primary-dark));
      color:#fff;
    }

    .rn-card{
      background:#fff;
      border-radius:16px;
      border:1px solid var(--line);
      padding:18px 20px 20px;
      box-shadow:0 8px 18px rgba(15,23,42,.06);
      margin-bottom:18px;
    }

    .rn-card-title{
      font-size:18px;
      font-weight:800;
      color:#0f172a;
      margin-bottom:10px;
    }

    .returns-new-page input,
    .returns-new-page select,
    .returns-new-page textarea{
      border-color:#cbd5e1 !important;
      border-radius:10px !important;
      padding:8px 10px !important;
      font-size:14px !important;
      transition:border-color .14s ease, box-shadow .14s ease;
    }

    .returns-new-page input:focus,
    .returns-new-page select:focus,
    .returns-new-page textarea:focus{
      border-color:#93c5fd !important;
      box-shadow:0 0 0 3px rgba(37,99,235,.15);
      outline:none;
    }

    .items-top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:10px;
      flex-wrap:wrap;
      gap:10px;
    }

    .items-stats{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }

    .items-chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      border:1px solid #e2e8f0;
      background:#f8fafc;
      color:#0f172a;
      font-size:13px;
      font-weight:700;
      border-radius:999px;
      padding:6px 10px;
    }

    .items-chip.total{
      border-color:#bfdbfe;
      background:#eff6ff;
      color:#1d4ed8;
    }

    .table-wrap{
      border:1px solid #e5e7eb;
      border-radius:12px;
      overflow:auto;
      background:#fff;
      margin-bottom:10px !important;
    }

    #items-table th{
      position:sticky;
      top:0;
      z-index:1;
      background:#f8fafc !important;
      color:#334155;
      text-transform:uppercase;
      letter-spacing:.05em;
      font-size:12px !important;
      font-weight:700 !important;
    }

    #items-table tbody tr:hover{ background:#f8fbff; }

    .items-actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:10px;
    }

    .items-note{
      margin-left:auto;
      color:#64748b;
      font-size:12px;
    }

    .rn-form-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .rn-link-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:9px 14px;
      border-radius:12px;
      font-size:14px;
      font-weight:700;
      text-decoration:none;
      color:#1d4ed8;
      border:1px solid #dbeafe;
      background:#eff6ff;
    }

    @media (max-width: 700px){
      .returns-new-page{
        margin:22px auto 52px;
        padding:0 14px;
      }
      .rn-header{ padding:16px; }
      .rn-title{ font-size:25px; }
      .rn-btn,.rn-link-btn{ width:100%; }
      .items-note{ margin-left:0; width:100%; }
    }
  </style>

  {# ---------- Top Bar ---------- #}
  <div class="rn-header">
    <div>
      <h1 class="rn-title">
        {% if mode == "sales" %}
          <span data-i18n="new_sales_return_title">New Sales Return</span>
        {% else %}
          <span data-i18n="new_purchase_return_title">New Purchase Return</span>
        {% endif %}
      </h1>
      <p class="rn-sub">
        <span data-i18n="returns_intro_1">
          Record returned goods and update stock & balances. Cash refunds are entered separately from the
        </span>
        <strong data-i18n="new_payment_receipt">New Payment / Receipt</strong>
        <span data-i18n="returns_intro_2">page.</span>
      </p>
    </div>
    <div class="rn-actions">
      <a href="{% url 'dashboard' %}" class="rn-btn">
        <span data-i18n="back_dashboard">â† Dashboard</span>
      </a>
      <a href="{% url back_url_name %}" class="rn-btn rn-btn-primary">
        {% if mode == "sales" %}
          <span data-i18n="back_to_sales">â† Back to Sales</span>
        {% else %}
          <span data-i18n="back_to_purchases">â† Back to Purchases</span>
        {% endif %}
      </a>
    </div>
  </div>

  {# ---------- Error ---------- #}
  {% if error %}
    <div style="margin-bottom:16px;padding:10px 12px;border-radius:10px;
                font-size:14px;background:#fee2e2;color:#b91c1c;border:1px solid #fecaca;">
      {{ error }}
    </div>
  {% endif %}

  <form method="post">
    {% csrf_token %}

    {# ---------- Header card ---------- #}
    <div class="rn-card">
      <div class="rn-card-title">
        {% if mode == "sales" %}
          <span data-i18n="sales_return_details">Sales Return Details</span>
        {% else %}
          <span data-i18n="purchase_return_details">Purchase Return Details</span>
        {% endif %}
      </div>

      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px;">
        <label style="font-size:14px;display:flex;flex-direction:column;gap:4px;">
          <span>{{ party_label }}</span>
          <select name="party" required
                  style="padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;">
            <option value=""
                    data-i18n="select_party_option"
                    data-i18n-args='{"party":"{{ party_label|escapejs }}"}'>
              -- Select {{ party_label }} --
            </option>
            {% for p in parties %}
              <option value="{{ p.id }}">{{ p.name }}</option>
            {% endfor %}
          </select>
        </label>

        <label style="font-size:14px;display:flex;flex-direction:column;gap:4px;">
          <span data-i18n="return_date">Return Date</span>
          <input type="date"
                 name="return_date"
                 value="{{ today }}"
                 style="padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;">
        </label>

        <label style="font-size:14px;display:flex;flex-direction:column;gap:4px;">
          <span>
            {% if mode == "sales" %}
              <span data-i18n="related_sales_invoice_optional">Related Sales Invoice (optional)</span>
            {% else %}
              <span data-i18n="related_purchase_invoice_optional">Related Purchase Invoice (optional)</span>
            {% endif %}
          </span>
          <select name="original_invoice"
                  style="padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;">
            <option value="" data-i18n="none_option">-- None --</option>
            {% for inv in invoices %}
              {% if mode == "sales" %}
                <option value="{{ inv.id }}">Inv {{ inv.invoice_number|default:inv.id }} â€“ {{ inv.customer.name }} ({{ inv.invoice_date }})</option>
              {% else %}
                <option value="{{ inv.id }}">Inv {{ inv.invoice_number|default:inv.id }} â€“ {{ inv.supplier.name }} ({{ inv.invoice_date }})</option>
              {% endif %}
            {% endfor %}
          </select>
        </label>
      </div>

      <label style="margin-top:12px;display:block;font-size:14px;">
        <span style="display:block;margin-bottom:4px;" data-i18n="notes_optional">Notes (optional)</span>
        <textarea name="notes"
                  rows="2"
                  style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;resize:vertical;"></textarea>
      </label>
    </div>

    {# ---------- Items card (mirrors sales_new.html) ---------- #}
    <div class="rn-card">
      <div class="items-top">
        <div class="rn-card-title" style="margin-bottom:0;" data-i18n="returned_items">Returned Items</div>
        <div class="items-stats">
          <div class="items-chip"><span data-i18n="lines_label">Lines</span>: <span id="items-line-count">0</span></div>
          <div class="items-chip"><span data-i18n="total_qty_label">Total Qty</span>: <span id="items-total-qty">0.000</span></div>
          <div id="items-total-display" class="items-chip total">
          <span data-i18n="total_return_value">Total Return Value:</span>
          <span data-i18n="rs_prefix">Rs</span>
          <span id="items-total-amount">0.00</span>
          </div>
        </div>
      </div>

      <div class="table-wrap" style="margin-bottom:10px;">
        <table id="items-table"
               style="border-collapse:collapse;width:100%;min-width:860px;">
          <thead>
            <tr>
              <th style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;background:#f9fafb;text-align:left;font-weight:600;"
                  data-i18n="col_product">Product</th>
              <th style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;background:#f9fafb;text-align:left;font-weight:600;"
                  data-i18n="col_unit">Unit</th>
              <th style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;background:#f9fafb;text-align:right;font-weight:600;"
                  data-i18n="col_unit_price">Unit Price</th>
              <th style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;background:#f9fafb;text-align:right;font-weight:600;"
                  data-i18n="col_qty_returned">Quantity Returned</th>
              <th style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;background:#f9fafb;text-align:right;font-weight:600;"
                  data-i18n="col_line_total">Line Total</th>
              <th style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;background:#f9fafb;text-align:center;font-weight:600;"></th>
            </tr>
          </thead>
          <tbody>

            {% if edit_mode %}
          
              {# ---------------- Existing return items ---------------- #}
              {% for item in items %}
                {% with forloop.counter as idx %}
                <tr data-row-index="{{ idx }}"
                    data-unit-code="{{ item.product.unit }}"
                    data-packing-type="{{ item.product.packing_type|default:'NONE' }}"
                    data-pieces-per-pack="{{ item.product.pieces_per_pack|default:1 }}"
                    data-packing-label="{{ item.product.get_packing_type_display|default:'' }}">
          
                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;">
                    <select name="product_{{ idx }}" class="product-select"
                            style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;">
                      <option value="" data-i18n="select_option">-- Select --</option>
                      {% for p in products %}
                        <option value="{{ p.id }}"
                                data-unit="{{ p.unit }}"
                                data-price="{% if mode == 'sales' %}{{ p.sale_price_per_unit|floatformat:2 }}{% else %}{{ p.purchase_price_per_unit|floatformat:2 }}{% endif %}"
                                data-packing-type="{{ p.packing_type|default:'NONE' }}"
                                data-pieces-per-pack="{{ p.pieces_per_pack|default:1 }}"
                                data-packing-label="{{ p.get_packing_type_display|default:'' }}"
                                {% if p.id == item.product.id %}selected{% endif %}>
                          {{ p.code }} - {{ p.name }}
                        </option>
                      {% endfor %}
                    </select>
                  </td>
          
                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;">
                    <select name="unit_{{ idx }}" class="unit-select"
                            style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;">
                      <option value="UNIT"
                        {% if item.unit_mode|default:"UNIT" == "UNIT" %}selected{% endif %}>
                        <span data-i18n="base_prefix">Base</span> {{ item.product.get_unit_display }}
                      </option>
                      {% if item.product.packing_type != "NONE" and item.product.pieces_per_pack > 1 %}
                        <option value="PACK"
                          {% if item.unit_mode == "PACK" %}selected{% endif %}>
                          {{ item.product.get_packing_type_display }}
                          ({{ item.product.pieces_per_pack }} Ã— {{ item.product.get_unit_display }})
                        </option>
                      {% endif %}
                    </select>
                  </td>
          
                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:right;">
                    <input type="number"
                           step="0.01"
                           name="unit_price_{{ idx }}"
                           class="price-input"
                           value="{{ item.unit_price|floatformat:2 }}"
                           style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;text-align:right;">
                  </td>
          
                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:right;">
                    <input type="number"
                           step="0.001"
                           class="qty-display-input"
                           value="{{ item.quantity }}"
                           style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;text-align:right;">
                    <input type="hidden"
                           name="quantity_{{ idx }}"
                           class="qty-hidden-input"
                           value="{{ item.quantity }}">
                  </td>
          
                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:right;">
                    <span data-i18n="rs_prefix">Rs</span> <span class="line-total">0.00</span>
                  </td>
          
                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:center;">
                    <button type="button"
                            class="btn btn-sm btn-danger"
                            onclick="removeRow(this)"
                            style="padding:4px 9px;border-radius:999px;font-size:13px;">
                      âœ•
                    </button>
                  </td>
                </tr>
                {% endwith %}
              {% endfor %}
          
              {# ---------------- Extra blank rows in edit mode ---------------- #}
              {% for _ in "12345" %}
                {% with items|length|add:forloop.counter as idx %}
                <tr data-row-index="{{ idx }}"
                    data-unit-code=""
                    data-packing-type="NONE"
                    data-pieces-per-pack="1"
                    data-packing-label="">
          
                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;">
                    <select name="product_{{ idx }}" class="product-select"
                            style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;">
                      <option value="" data-i18n="select_option">-- Select --</option>
                      {% for p in products %}
                        <option value="{{ p.id }}"
                                data-unit="{{ p.unit }}"
                                data-price="{% if mode == 'sales' %}{{ p.sale_price_per_unit|floatformat:2 }}{% else %}{{ p.purchase_price_per_unit|floatformat:2 }}{% endif %}"
                                data-packing-type="{{ p.packing_type|default:'NONE' }}"
                                data-pieces-per-pack="{{ p.pieces_per_pack|default:1 }}"
                                data-packing-label="{{ p.get_packing_type_display|default:'' }}">
                          {{ p.code }} - {{ p.name }}
                        </option>
                      {% endfor %}
                    </select>
                  </td>
          
                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;">
                    <select name="unit_{{ idx }}" class="unit-select"
                            style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;">
                      <option value="" data-i18n="unit_option">-- Unit --</option>
                    </select>
                  </td>
          
                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:right;">
                    <input type="number"
                           step="0.01"
                           name="unit_price_{{ idx }}"
                           class="price-input"
                           style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;text-align:right;">
                  </td>
          
                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:right;">
                    <input type="number"
                           step="0.001"
                           class="qty-display-input"
                           placeholder="Qty"
                           data-i18n-placeholder="qty_placeholder"
                           style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;text-align:right;">
                    <input type="hidden"
                           name="quantity_{{ idx }}"
                           class="qty-hidden-input">
                  </td>
          
                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:right;">
                    <span data-i18n="rs_prefix">Rs</span> <span class="line-total">0.00</span>
                  </td>
          
                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:center;">
                    <button type="button"
                            class="btn btn-sm btn-danger"
                            onclick="removeRow(this)"
                            style="padding:4px 9px;border-radius:999px;font-size:13px;">
                      âœ•
                    </button>
                  </td>
                </tr>
                {% endwith %}
              {% endfor %}
          
            {% else %}
          
              {# ---------------- New return: 5 default rows ---------------- #}
              {% for _ in "12345" %}
                {% with forloop.counter as idx %}
                <tr data-row-index="{{ idx }}"
                    data-unit-code=""
                    data-packing-type="NONE"
                    data-pieces-per-pack="1"
                    data-packing-label="">
                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;">
                    <select name="product_{{ idx }}"
                            class="product-select"
                            style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;">
                      <option value="" data-i18n="select_option">-- Select --</option>
                      {% for p in products %}
                        <option value="{{ p.id }}"
                                data-unit="{{ p.unit }}"
                                data-price="{% if mode == 'sales' %}{{ p.sale_price_per_unit|floatformat:2 }}{% else %}{{ p.purchase_price_per_unit|floatformat:2 }}{% endif %}"
                                data-packing-type="{{ p.packing_type|default:'NONE' }}"
                                data-pieces-per-pack="{{ p.pieces_per_pack|default:1 }}"
                                data-packing-label="{{ p.get_packing_type_display|default:'' }}">
                          {{ p.code }} - {{ p.name }}
                        </option>
                      {% endfor %}
                    </select>
                  </td>
          
                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;">
                    <select name="unit_{{ idx }}"
                            class="unit-select"
                            style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;">
                      <option value="" data-i18n="unit_option">-- Unit --</option>
                    </select>
                  </td>
          
                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:right;">
                    <input type="number"
                           step="0.01"
                           name="unit_price_{{ idx }}"
                           class="price-input"
                           style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;text-align:right;">
                  </td>
          
                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:right;">
                    <input type="number"
                           step="0.001"
                           class="qty-display-input"
                           placeholder="Qty"
                           data-i18n-placeholder="qty_placeholder"
                           style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;text-align:right;">
                    <input type="hidden"
                           name="quantity_{{ idx }}"
                           class="qty-hidden-input">
                  </td>
          
                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:right;">
                    <span data-i18n="rs_prefix">Rs</span> <span class="line-total">0.00</span>
                  </td>
          
                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:center;">
                    <button type="button"
                            class="btn btn-sm btn-danger"
                            onclick="removeRow(this)"
                            style="padding:4px 9px;border-radius:999px;font-size:13px;">
                      âœ•
                    </button>
                  </td>
                </tr>
                {% endwith %}
              {% endfor %}
          
            {% endif %}
          </tbody>
        </table>
      </div>

      <div class="items-actions">
        <button type="button" class="rn-btn" onclick="addRow()" data-i18n="add_item_row">+ Add Item Row</button>
        <button type="button" class="rn-btn" onclick="removeEmptyRows()" data-i18n="remove_empty_rows_btn">Remove Empty Rows</button>
        <div class="items-note"><span data-i18n="shortcut_note_prefix">Shortcut:</span> <strong>Alt + =</strong> <span data-i18n="shortcut_note_suffix">adds a row quickly</span></div>
      </div>
    </div>

    {# ---------- Actions ---------- #}
    <div class="rn-form-actions">
      <button type="submit"
              class="rn-btn rn-btn-primary"
              data-i18n="save_post_return">
        ğŸ’¾ Save &amp; Post Return
      </button>
      <a href="{% url back_url_name %}"
         class="rn-link-btn"
         data-i18n="cancel">
        Cancel
      </a>
    </div>
  </form>
</div>

{# -------- JS: product meta + totals (similar to sales_new, no payment) -------- #}
<script>
let returnsRowCounter = 5;

// âœ… Invoice pricing support
let activeInvoiceId = "";
let invoicePriceMap = {};   // { "product_id": "unit_price" }

function getInvoicePricesUrl(invoiceId) {
  if (!invoiceId) return null;

  const base =
    "{% if mode == 'sales' %}{% url 'sales_invoice_item_prices_api' 999999 %}{% else %}{% url 'purchase_invoice_item_prices_api' 999999 %}{% endif %}";
  return base.replace("999999", invoiceId);
}

const UNIT_LABELS = {
  "BAG": "Bag",
  "KG": "Kilogram",
  "LITRE": "Litre",
  "UNIT": "Unit / Piece"
};

// format helper
function fmt(amount) {
  const n = parseFloat(amount || 0) || 0;
  return n.toFixed(2);
}

function recalcGrandTotal() {
  const rows = document.querySelectorAll('#items-table tbody tr');
  let itemsTotal = 0;
  let totalQty = 0;
  let lineCount = 0;

  rows.forEach(tr => {
    const totalSpan = tr.querySelector('.line-total');
    const lineVal = parseFloat((totalSpan && totalSpan.textContent) || 0) || 0;
    itemsTotal += lineVal;

    const product = tr.querySelector('.product-select');
    const qtyHidden = tr.querySelector('.qty-hidden-input');
    const qtyVal = parseFloat((qtyHidden && qtyHidden.value) || 0) || 0;
    if (product && product.value) {
      lineCount += 1;
      totalQty += qtyVal;
    }
  });

  const grandTotal = itemsTotal;
  const span = document.getElementById('items-total-amount');
  if (span) {
    span.textContent = fmt(grandTotal);
  }
  const lineNode = document.getElementById('items-line-count');
  const qtyNode = document.getElementById('items-total-qty');
  if (lineNode) lineNode.textContent = String(lineCount);
  if (qtyNode) qtyNode.textContent = (totalQty || 0).toFixed(3);
}

function applyInvoicePricesToAllRows() {
  const rows = document.querySelectorAll('#items-table tbody tr');

  rows.forEach(tr => {
    const productSelect = tr.querySelector('.product-select');
    const priceInput = tr.querySelector('.price-input');
    if (!productSelect || !priceInput) return;

    const pid = productSelect.value ? String(productSelect.value) : "";
    if (!pid) return;

    const wasAuto = priceInput.dataset.autofill === "1";

    // âœ… If invoice removed, revert ONLY autofilled prices to product default price
    if (!activeInvoiceId) {
      if (wasAuto) {
        const opt = productSelect.selectedOptions[0];
        const basePrice = (opt && opt.dataset.price) ? opt.dataset.price : "";
        priceInput.value = basePrice;
        priceInput.dataset.autofill = "1";
        syncRow(tr);
      }
      return;
    }

    // âœ… If invoice selected, apply invoice price when available
    const invPrice = invoicePriceMap[pid];
    if (!invPrice) return;

    const isEmpty = !priceInput.value || String(priceInput.value).trim() === "";
    if (isEmpty || wasAuto) {
      priceInput.value = invPrice;
      priceInput.dataset.autofill = "1";
      syncRow(tr);
    }
  });

  recalcGrandTotal();
}
// sync a single row (qty, unit, price, total)
function syncRow(tr) {
  const productSelect = tr.querySelector('.product-select');
  const unitSelect = tr.querySelector('.unit-select');
  const priceInput = tr.querySelector('.price-input');
  const qtyDisplayInput = tr.querySelector('.qty-display-input');
  const qtyHiddenInput = tr.querySelector('.qty-hidden-input');
  const totalSpan = tr.querySelector('.line-total');

  if (!productSelect || !unitSelect || !priceInput || !qtyDisplayInput || !qtyHiddenInput || !totalSpan) {
    return;
  }

  const price = parseFloat(priceInput.value || 0) || 0;
  const displayQty = parseFloat(qtyDisplayInput.value || 0) || 0;

  const unitMode = unitSelect.value || "UNIT";  // "UNIT" (base) or "PACK"
  const piecesPerPack = parseFloat(tr.dataset.piecesPerPack || "1") || 1;

  let multiplier = 1;
  if (unitMode === "PACK") {
    multiplier = piecesPerPack;
  }

  const baseQty = displayQty * multiplier;

  if (baseQty > 0) {
    qtyHiddenInput.value = baseQty.toFixed(3);
  } else {
    qtyHiddenInput.value = "";
  }

  const lineTotal = baseQty * price;
  totalSpan.textContent = fmt(lineTotal);
}

// when product changes, set price + packing metadata and rebuild unit dropdown
function handleProductChange(selectEl) {
  const tr = selectEl.closest('tr');
  const unitSelect = tr.querySelector('.unit-select');
  const priceInput = tr.querySelector('.price-input');

  const opt = selectEl.selectedOptions[0];

  // reset row packing metadata
  tr.dataset.unitCode = "";
  tr.dataset.packingType = "NONE";
  tr.dataset.piecesPerPack = "1";
  tr.dataset.packingLabel = "";

  unitSelect.innerHTML = '<option value="">-- Unit --</option>';

  if (opt) {
    const unitCode = opt.dataset.unit || "";
    const basePrice = opt.dataset.price || "";
    const packingType = opt.dataset.packingType || "NONE";
    const piecesPerPack = opt.dataset.piecesPerPack || "1";
    const packingLabel = opt.dataset.packingLabel || "";

    tr.dataset.unitCode = unitCode;
    tr.dataset.packingType = packingType;
    tr.dataset.piecesPerPack = piecesPerPack;
    tr.dataset.packingLabel = packingLabel;

    // âœ… default unit price:
    // 1) if invoice selected and invoice has this product -> use invoice price
    // 2) else fallback to product price
    const pid = opt ? String(opt.value || "") : "";
    if (activeInvoiceId && pid && invoicePriceMap[pid]) {
      priceInput.value = invoicePriceMap[pid];
      priceInput.dataset.autofill = "1";
    } else {
      priceInput.value = basePrice;
      priceInput.dataset.autofill = "1";
    }

    if (unitCode) {
      const baseLabel = UNIT_LABELS[unitCode] || "Unit";
      const baseOpt = document.createElement('option');
      baseOpt.value = "UNIT";
      baseOpt.textContent = `Base ${baseLabel}`;
      unitSelect.appendChild(baseOpt);
    }

    const ppNum = parseFloat(piecesPerPack || "1") || 1;
    if (packingType !== "NONE" && ppNum > 1) {
      const packOpt = document.createElement('option');
      packOpt.value = "PACK";
      const unitLabel = UNIT_LABELS[unitCode] || "Unit";
      packOpt.textContent = `${packingLabel} (${ppNum} Ã— ${unitLabel})`;
      unitSelect.appendChild(packOpt);
    }

    unitSelect.value = "UNIT";
  }

  syncRow(tr);
  recalcGrandTotal();
}

function handleQtyOrPriceChange(inputEl) {
  const tr = inputEl.closest('tr');
  syncRow(tr);
  recalcGrandTotal();
}

function handleUnitChange(selectEl) {
  const tr = selectEl.closest('tr');
  syncRow(tr);
  recalcGrandTotal();
}

function addRow() {
  const tbody = document.querySelector('#items-table tbody');
  const lastRow = tbody.querySelector('tr:last-child');

  let nextIndex = 1;
  if (lastRow) {
    nextIndex = (parseInt(lastRow.dataset.rowIndex || "0", 10) || 0) + 1;
  }

  // keep counter in sync (optional but nice)
  returnsRowCounter = nextIndex;

  const row = document.createElement('tr');
  row.setAttribute('data-row-index', nextIndex);

  row.dataset.unitCode = "";
  row.dataset.packingType = "NONE";
  row.dataset.piecesPerPack = "1";
  row.dataset.packingLabel = "";

  row.innerHTML = `
  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;">
    <select name="product_${nextIndex}" class="product-select"
            style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;">
      <option value="" data-i18n="select_option">-- Select --</option>
      {% for p in products %}
        <option
          value="{{ p.id }}"
          data-unit="{{ p.unit }}"
          data-price="{% if mode == 'sales' %}{{ p.sale_price_per_unit|floatformat:2 }}{% else %}{{ p.purchase_price_per_unit|floatformat:2 }}{% endif %}"
          data-packing-type="{{ p.packing_type|default:'NONE' }}"
          data-pieces-per-pack="{{ p.pieces_per_pack|default:1 }}"
          data-packing-label="{{ p.get_packing_type_display|default:'' }}"
        >
          {{ p.code }} - {{ p.name }}
        </option>
      {% endfor %}
    </select>
  </td>

  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;">
    <select name="unit_${nextIndex}" class="unit-select"
            style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;">
      <option value="" data-i18n="unit_option">-- Unit --</option>
    </select>
  </td>

  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:right;">
    <input type="number"
           step="0.01"
           name="unit_price_${nextIndex}"
           class="price-input"
           style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;text-align:right;">
  </td>

  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:right;">
    <input type="number"
           step="0.001"
           class="qty-display-input"
           placeholder="Qty"
           data-i18n-placeholder="qty_placeholder"
           style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;text-align:right;">
    <input type="hidden"
           name="quantity_${nextIndex}"
           class="qty-hidden-input">
  </td>

  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:right;">
    <span data-i18n="rs_prefix">Rs</span> <span class="line-total">0.00</span>
  </td>

  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:center;">
    <button type="button"
            class="btn btn-sm btn-danger"
            onclick="removeRow(this)"
            style="padding:4px 9px;border-radius:999px;font-size:13px;">
      âœ•
    </button>
  </td>
`;
  tbody.appendChild(row);
  attachRowEvents(row);
  syncRow(row);
  recalcGrandTotal();
    // âœ… if invoice selected, apply invoice price to the new row too
    if (activeInvoiceId && invoicePriceMap) {
      applyInvoicePricesToAllRows();
    }

  // âœ… apply language to newly added row if Urdu system exists
  if (window.applyLang) {
    window.applyLang(localStorage.getItem("roz_lang") || "en");
  }
}

function removeRow(btn) {
  const tr = btn.closest('tr');
  tr.parentNode.removeChild(tr);
  recalcGrandTotal();
}

function removeEmptyRows() {
  const rows = Array.from(document.querySelectorAll('#items-table tbody tr'));
  rows.forEach((tr) => {
    const product = tr.querySelector('.product-select');
    const qtyDisplay = tr.querySelector('.qty-display-input');
    const priceInput = tr.querySelector('.price-input');
    const hasProduct = !!(product && product.value);
    const qty = parseFloat((qtyDisplay && qtyDisplay.value) || 0) || 0;
    const price = parseFloat((priceInput && priceInput.value) || 0) || 0;
    if (!hasProduct && qty <= 0 && price <= 0) {
      tr.remove();
    }
  });
  recalcGrandTotal();
}

function attachRowEvents(tr) {
  const productSelect = tr.querySelector('.product-select');
  const priceInput = tr.querySelector('.price-input');
  const qtyDisplayInput = tr.querySelector('.qty-display-input');
  const unitSelect = tr.querySelector('.unit-select');

  if (productSelect) {
    productSelect.addEventListener('change', () => handleProductChange(productSelect));
  }
  if (priceInput) {
    priceInput.addEventListener('input', () => {
      priceInput.dataset.autofill = "0"; // âœ… user override
      handleQtyOrPriceChange(priceInput);
    });
  }
  if (qtyDisplayInput) {
    qtyDisplayInput.addEventListener('input', () => handleQtyOrPriceChange(qtyDisplayInput));
  }
  if (unitSelect) {
    unitSelect.addEventListener('change', () => handleUnitChange(unitSelect));
  }
}

document.addEventListener('DOMContentLoaded', function() {
  // 1) Make counter match the REAL last row in DOM (important for edit mode)
  const lastRow = document.querySelector('#items-table tbody tr:last-child');
  if (lastRow) {
    const maxIdx = parseInt(lastRow.dataset.rowIndex || "0", 10) || 0;
    if (maxIdx > 0) returnsRowCounter = maxIdx;
  }

  // 2) Attach events + compute totals for ALL rows (existing edit rows + blank rows)
  document.querySelectorAll('#items-table tbody tr').forEach(tr => {
    attachRowEvents(tr);
    syncRow(tr);   // âœ… ensures edit rows calculate line totals on page load
  });

  // 3) Now compute grand total
  recalcGrandTotal();

  // âœ… Invoice dropdown -> load invoice prices and auto-apply
  const invSelect = document.querySelector('select[name="original_invoice"]');
  if (invSelect) {
    invSelect.addEventListener("change", async () => {
      activeInvoiceId = invSelect.value ? String(invSelect.value) : "";
      invoicePriceMap = {};

      if (!activeInvoiceId) {
        // no invoice selected
        applyInvoicePricesToAllRows();
        return;
      }

      const url = getInvoicePricesUrl(activeInvoiceId);
      if (!url) return;

      try {
        const resp = await fetch(url, {
          headers: { "X-Requested-With": "XMLHttpRequest" }
        });
        if (!resp.ok) throw new Error("Bad response");
        const data = await resp.json();
        invoicePriceMap = (data && data.prices) ? data.prices : {};
        applyInvoicePricesToAllRows();
      } catch (e) {
        invoicePriceMap = {};
        // fail silently (keep UX smooth)
      }
    });
  }

  // âœ… Apply saved language on page load (if Urdu system exists)
  if (window.applyLang) {
    window.applyLang(localStorage.getItem("roz_lang") || "en");
  }

  document.addEventListener('keydown', function(e) {
    if (e.altKey && e.key === '=') {
      e.preventDefault();
      addRow();
    }
  });
});
</script>

<script>
  window.ROZ_I18N = window.ROZ_I18N || { en: {}, ur: {} };

  Object.assign(window.ROZ_I18N.en, {
    new_sales_return_title: "New Sales Return",
    new_purchase_return_title: "New Purchase Return",
    returns_intro_1: "Record returned goods and update stock & balances. Cash refunds are entered separately from the",
    new_payment_receipt: "New Payment / Receipt",
    returns_intro_2: "page.",
    back_dashboard: "â† Dashboard",
    back_to_sales: "â† Back to Sales",
    back_to_purchases: "â† Back to Purchases",
    sales_return_details: "Sales Return Details",
    purchase_return_details: "Purchase Return Details",
    return_date: "Return Date",
    related_sales_invoice_optional: "Related Sales Invoice (optional)",
    related_purchase_invoice_optional: "Related Purchase Invoice (optional)",
    none_option: "-- None --",
    notes_optional: "Notes (optional)",
    returned_items: "Returned Items",
    total_return_value: "Total Return Value:",
    rs_prefix: "Rs",
    col_product: "Product",
    col_unit: "Unit",
    col_unit_price: "Unit Price",
    col_qty_returned: "Quantity Returned",
    col_line_total: "Line Total",
    select_option: "-- Select --",
    unit_option: "-- Unit --",
    qty_placeholder: "Qty",
    add_item_row: "+ Add Item Row",
    remove_empty_rows_btn: "Remove Empty Rows",
    lines_label: "Lines",
    total_qty_label: "Total Qty",
    shortcut_note_prefix: "Shortcut:",
    shortcut_note_suffix: "adds a row quickly",
    save_post_return: "ğŸ’¾ Save & Post Return",
    cancel: "Cancel",
    base_prefix: "Base"
  });

  Object.assign(window.ROZ_I18N.ur, {
    new_sales_return_title: "Ù†ÛŒØ§ Ø³ÛŒÙ„Ø² Ø±ÛŒÙ¹Ø±Ù†",
    new_purchase_return_title: "Ù†ÛŒØ§ Ù¾Ø±Ú†ÛŒØ² Ø±ÛŒÙ¹Ø±Ù†",
    returns_intro_1: "ÙˆØ§Ù¾Ø³ Ø¢Ù†Û’ ÙˆØ§Ù„Ø§ Ù…Ø§Ù„ Ø±ÛŒÚ©Ø§Ø±Úˆ Ú©Ø±ÛŒÚº Ø§ÙˆØ± Ø§Ø³Ù¹Ø§Ú© Ø§ÙˆØ± Ø¨ÛŒÙ„Ù†Ø³ Ø§Ù¾ÚˆÛŒÙ¹ Ú©Ø±ÛŒÚºÛ” Ú©ÛŒØ´ Ø±ÛŒÙÙ†Úˆ Ø§Ù„Ú¯ Ø³Û’",
    new_payment_receipt: "Ù†Ø¦ÛŒ Ø§Ø¯Ø§Ø¦ÛŒÚ¯ÛŒ / Ø±Ø³ÛŒØ¯",
    returns_intro_2: "ØµÙØ­Û Ø³Û’ Ø¯Ø±Ø¬ Ú©ÛŒØ§ Ø¬Ø§ØªØ§ ÛÛ’Û”",
    back_dashboard: "â† ÚˆÛŒØ´ Ø¨ÙˆØ±Úˆ",
    back_to_sales: "â† Ø³ÛŒÙ„Ø² Ù¾Ø± ÙˆØ§Ù¾Ø³",
    back_to_purchases: "â† Ù¾Ø±Ú†ÛŒØ² Ù¾Ø± ÙˆØ§Ù¾Ø³",
    sales_return_details: "Ø³ÛŒÙ„Ø² Ø±ÛŒÙ¹Ø±Ù† Ú©ÛŒ ØªÙØµÛŒÙ„Ø§Øª",
    purchase_return_details: "Ù¾Ø±Ú†ÛŒØ² Ø±ÛŒÙ¹Ø±Ù† Ú©ÛŒ ØªÙØµÛŒÙ„Ø§Øª",
    return_date: "Ø±ÛŒÙ¹Ø±Ù† Ú©ÛŒ ØªØ§Ø±ÛŒØ®",
    related_sales_invoice_optional: "Ù…ØªØ¹Ù„Ù‚Û Ø³ÛŒÙ„Ø² Ø§Ù†ÙˆØ§Ø¦Ø³ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)",
    related_purchase_invoice_optional: "Ù…ØªØ¹Ù„Ù‚Û Ù¾Ø±Ú†ÛŒØ² Ø§Ù†ÙˆØ§Ø¦Ø³ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)",
    none_option: "-- Ú©ÙˆØ¦ÛŒ Ù†ÛÛŒÚº --",
    notes_optional: "Ù†ÙˆÙ¹Ø³ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)",
    returned_items: "ÙˆØ§Ù¾Ø³ Ú©ÛŒ Ú¯Ø¦ÛŒ Ø§Ø´ÛŒØ§Ø¡",
    total_return_value: "Ú©Ù„ Ø±ÛŒÙ¹Ø±Ù† ÙˆÛŒÙ„ÛŒÙˆ:",
    rs_prefix: "Ø±ÙˆÙ¾Û’",
    col_product: "Ù¾Ø±ÙˆÚˆÚ©Ù¹",
    col_unit: "ÛŒÙˆÙ†Ù¹",
    col_unit_price: "ÙÛŒ ÛŒÙˆÙ†Ù¹ Ù‚ÛŒÙ…Øª",
    col_qty_returned: "ÙˆØ§Ù¾Ø³ Ú©ÛŒ Ú¯Ø¦ÛŒ Ù…Ù‚Ø¯Ø§Ø±",
    col_line_total: "Ù„Ø§Ø¦Ù† Ù¹ÙˆÙ¹Ù„",
    select_option: "-- Ù…Ù†ØªØ®Ø¨ Ú©Ø±ÛŒÚº --",
    unit_option: "-- ÛŒÙˆÙ†Ù¹ --",
    qty_placeholder: "Ù…Ù‚Ø¯Ø§Ø±",
    add_item_row: "+ Ù†Ø¦ÛŒ Ù„Ø§Ø¦Ù† Ø´Ø§Ù…Ù„ Ú©Ø±ÛŒÚº",
    remove_empty_rows_btn: "Ø®Ø§Ù„ÛŒ Ù‚Ø·Ø§Ø±ÛŒÚº ÛÙ¹Ø§Ø¦ÛŒÚº",
    lines_label: "Ù‚Ø·Ø§Ø±ÛŒÚº",
    total_qty_label: "Ú©Ù„ Ù…Ù‚Ø¯Ø§Ø±",
    shortcut_note_prefix: "Ø´Ø§Ø±Ù¹ Ú©Ù¹:",
    shortcut_note_suffix: "Ø¬Ù„Ø¯ÛŒ Ù†Ø¦ÛŒ Ù‚Ø·Ø§Ø± Ø´Ø§Ù…Ù„ Ú©Ø±ÛŒÚº",
    save_post_return: "ğŸ’¾ Ù…Ø­ÙÙˆØ¸ Ú©Ø±ÛŒÚº Ø§ÙˆØ± Ù¾ÙˆØ³Ù¹ Ú©Ø±ÛŒÚº",
    cancel: "Ù…Ù†Ø³ÙˆØ® Ú©Ø±ÛŒÚº",
    base_prefix: "Ø¨Ù†ÛŒØ§Ø¯ÛŒ"
  });
</script>

{% endblock %}
