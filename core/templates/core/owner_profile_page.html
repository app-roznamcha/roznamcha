{% extends "core/base.html" %}
{% block title %}Profile{% endblock %}
{% block content %}

<div class="container" style="max-width: 950px; margin: 30px auto; padding: 0 14px;">
  <div style="display:flex;align-items:flex-end;justify-content:space-between;gap:12px;flex-wrap:wrap;">
    <div>
      <h2 style="margin:0 0 6px;">Profile</h2>
      <p style="margin:0;color:#6b7280;">Manage owner details, company profile, and staff accounts.</p>
    </div>
  </div>

  <!-- =========================
       Owner Details (View + Edit)
       ========================= -->
    <div class="profile-card" style="margin-top:18px;padding:16px;border:1px solid #e5e7eb;border-radius:14px;background:#fff;">
    <h4 style="margin:0 0 10px;">Owner Details</h4>

    <div class="profile-grid-2" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div style="padding:12px;border:1px solid #f1f5f9;border-radius:12px;background:#f8fafc;">
        <p style="margin:6px 0;"><strong>Username:</strong> {{ owner.username }}</p>
        <p style="margin:6px 0;"><strong>Role:</strong> {{ profile.role }}</p>
      </div>

      <div style="padding:12px;border:1px solid #f1f5f9;border-radius:12px;background:#f8fafc;">
        <p style="margin:6px 0;"><strong>Current Name:</strong> {{ owner.get_full_name|default:"-" }}</p>
        <p style="margin:6px 0;"><strong>Email:</strong> {{ owner.email|default:"-" }}</p>
      </div>
    </div>

    <hr style="margin:14px 0;border:none;border-top:1px solid #e5e7eb;">

    <form method="post" style="margin:0;">
      {% csrf_token %}
      <input type="hidden" name="action" value="update_owner"/>

      <div class="profile-grid-3" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;">
        <div>
          <label style="font-weight:600;">First name</label><br/>
          {{ owner_form.first_name }}
          {% if owner_form.first_name.errors %}
            <div style="color:#b91c1c;font-size:13px;">{{ owner_form.first_name.errors }}</div>
          {% endif %}
        </div>

        <div>
          <label style="font-weight:600;">Last name</label><br/>
          {{ owner_form.last_name }}
          {% if owner_form.last_name.errors %}
            <div style="color:#b91c1c;font-size:13px;">{{ owner_form.last_name.errors }}</div>
          {% endif %}
        </div>

        <div>
          <label style="font-weight:600;">Email</label><br/>
          {{ owner_form.email }}
          {% if owner_form.email.errors %}
            <div style="color:#b91c1c;font-size:13px;">{{ owner_form.email.errors }}</div>
          {% endif %}
        </div>
      </div>

      <button type="submit"
              style="margin-top:12px;padding:10px 16px;border-radius:10px;border:1px solid #2563eb;background:#2563eb;color:#fff;font-weight:700;cursor:pointer;">
        Save Owner Info
      </button>
    </form>
  </div>


    <!-- =========================
       Change Password
       ========================= -->
       <div class="profile-card" style="margin-top:16px;padding:16px;border:1px solid #e5e7eb;border-radius:14px;background:#fff;">
        <h4 style="margin:0 0 10px;">Change Password</h4>
        <p style="margin:0 0 10px;color:#6b7280;">For security, choose a strong password you don’t reuse elsewhere.</p>
    
        <form method="post" style="margin:0;max-width:520px;">
          {% csrf_token %}
          <input type="hidden" name="action" value="change_password"/>
    
          <div style="display:grid;gap:10px;">
            <div>
              <label style="font-weight:600;">Current password</label><br/>
              {{ password_form.old_password }}
              {% if password_form.old_password.errors %}
                <div style="color:#b91c1c;font-size:13px;">{{ password_form.old_password.errors }}</div>
              {% endif %}
            </div>
    
            <div>
              <label style="font-weight:600;">New password</label><br/>
              {{ password_form.new_password1 }}
              {% if password_form.new_password1.errors %}
                <div style="color:#b91c1c;font-size:13px;">{{ password_form.new_password1.errors }}</div>
              {% endif %}
            </div>
    
            <div>
              <label style="font-weight:600;">Confirm new password</label><br/>
              {{ password_form.new_password2 }}
              {% if password_form.new_password2.errors %}
                <div style="color:#b91c1c;font-size:13px;">{{ password_form.new_password2.errors }}</div>
              {% endif %}
            </div>
          </div>
    
          <button type="submit"
                  style="margin-top:12px;padding:10px 16px;border-radius:10px;border:1px solid #2563eb;background:#2563eb;color:#fff;font-weight:700;cursor:pointer;">
            Update Password
          </button>
        </form>
      </div>
  <!-- =========================
       Company Profile (View + Edit)
       ========================= -->
       <div class="profile-card" style="margin-top:16px;padding:16px;border:1px solid #e5e7eb;border-radius:14px;background:#fff;">
    <h4 style="margin:0 0 10px;">Company Profile</h4>

    <div style="display:flex;gap:14px;align-items:flex-start;flex-wrap:wrap;">
      <div style="width:120px;">
        {% if company and company.logo %}
          <img src="{{ company.logo.url }}"
               alt="{{ company.name }}"
               style="width:120px;height:120px;border-radius:14px;object-fit:cover;border:1px solid #e5e7eb;background:#fff;">
        {% else %}
          <div style="width:120px;height:120px;border-radius:14px;border:1px solid #e5e7eb;background:#f8fafc;display:flex;align-items:center;justify-content:center;font-weight:800;color:#2563eb;">
            LOGO
          </div>
        {% endif %}
      </div>

      <div style="flex:1;min-width:260px;">
        <p style="margin:6px 0;"><strong>Name:</strong> {{ company.name|default:"-" }}</p>
        <p style="margin:6px 0;"><strong>Phone:</strong> {{ company.phone|default:"-" }}</p>
        <p style="margin:6px 0;"><strong>Email:</strong> {{ company.email|default:"-" }}</p>
        <p style="margin:6px 0;"><strong>Address:</strong> {{ company.address|default:"-" }}</p>
      </div>
    </div>

    <hr style="margin:14px 0;border:none;border-top:1px solid #e5e7eb;">

    <form method="post" enctype="multipart/form-data" style="margin:0;">
      {% csrf_token %}
      <input type="hidden" name="action" value="update_company"/>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
        <div>
          <label style="font-weight:600;">Company name</label><br/>
          {{ company_form.name }}
          {% if company_form.name.errors %}
            <div style="color:#b91c1c;font-size:13px;">{{ company_form.name.errors }}</div>
          {% endif %}
        </div>

        <div>
          <label style="font-weight:600;">Phone</label><br/>
          {{ company_form.phone }}
          {% if company_form.phone.errors %}
            <div style="color:#b91c1c;font-size:13px;">{{ company_form.phone.errors }}</div>
          {% endif %}
        </div>

        <div>
          <label style="font-weight:600;">Email</label><br/>
          {{ company_form.email }}
          {% if company_form.email.errors %}
            <div style="color:#b91c1c;font-size:13px;">{{ company_form.email.errors }}</div>
          {% endif %}
        </div>

        <div>
          <label style="font-weight:600;">Logo</label><br/>
          {{ company_form.logo }}
          {% if company_form.logo.errors %}
            <div style="color:#b91c1c;font-size:13px;">{{ company_form.logo.errors }}</div>
          {% endif %}
        </div>

        <div style="grid-column:1 / -1;">
          <label style="font-weight:600;">Address</label><br/>
          {{ company_form.address }}
          {% if company_form.address.errors %}
            <div style="color:#b91c1c;font-size:13px;">{{ company_form.address.errors }}</div>
          {% endif %}
        </div>
      </div>

      <button type="submit"
              style="margin-top:12px;padding:10px 16px;border-radius:10px;border:1px solid #059669;background:#059669;color:#fff;font-weight:700;cursor:pointer;">
        Save Company Info
      </button>
    </form>
  </div>

  <!-- =========================
       Staff (Create + List)
       ========================= -->
       <div style="margin-top:16px;padding:16px;border:1px solid #e5e7eb;border-radius:14px;background:#fff;">
    <h4 style="margin:0 0 10px;">Create Staff (Max 3 accounts)</h4>

    <form method="post" style="margin:0;">
      {% csrf_token %}
      <input type="hidden" name="action" value="create_staff"/>

      <div class="profile-grid-3" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;max-width:820px;">
        <div>
          <label style="font-weight:600;">Username</label><br/>
          <input name="username" required style="width:100%;padding:10px;border-radius:10px;border:1px solid #e5e7eb;">
        </div>
        <div>
          <label style="font-weight:600;">Full Name</label><br/>
          <input name="full_name" style="width:100%;padding:10px;border-radius:10px;border:1px solid #e5e7eb;">
        </div>
        <div>
          <label style="font-weight:600;">Email</label><br/>
          <input name="email" type="email" required
                 style="width:100%;padding:10px;border-radius:10px;border:1px solid #e5e7eb;"
                 placeholder="staff@example.com">
        </div>
        <div>
            <label style="font-weight:600;">Password</label><br/>
            <input name="password" type="password" required
                   style="width:100%;padding:10px;border-radius:10px;border:1px solid #e5e7eb;"
                   placeholder="Enter password">
          </div>
      </div>

      <button type="submit"
              style="margin-top:12px;padding:10px 16px;border-radius:10px;border:1px solid #111827;background:#111827;color:#fff;font-weight:700;cursor:pointer;">
        Create Staff
      </button>
    </form>

    <hr style="margin:16px 0;border:none;border-top:1px solid #e5e7eb;">

    <h4 style="margin:0 0 10px;">Existing Staff</h4>
    {% if staff_profiles %}
      <div style="overflow:auto;">
        <table class="profile-table" style="width:100%;border-collapse:collapse;min-width:520px;">
            <thead>
                <tr>
                  <th style="text-align:left;border-bottom:1px solid #e5e7eb;padding:10px;">Username</th>
                  <th style="text-align:left;border-bottom:1px solid #e5e7eb;padding:10px;">Name</th>
                  <th style="text-align:left;border-bottom:1px solid #e5e7eb;padding:10px;">Email</th>
                  <th style="text-align:left;border-bottom:1px solid #e5e7eb;padding:10px;">Active</th>
                  <th style="text-align:left;border-bottom:1px solid #e5e7eb;padding:10px;">Action</th>
                </tr>
              </thead>
          <tbody>
            {% for sp in staff_profiles %}
            <tr>
                <td style="padding:10px;border-bottom:1px solid #f1f5f9;">{{ sp.user.username }}</td>
                <td style="padding:10px;border-bottom:1px solid #f1f5f9;">{{ sp.user.get_full_name|default:"-" }}</td>
                <td style="padding:10px;border-bottom:1px solid #f1f5f9;">{{ sp.user.email|default:"-" }}</td>
                <td style="padding:10px;border-bottom:1px solid #f1f5f9;">
                  {% if sp.is_active %}✅ Yes{% else %}❌ No{% endif %}
                </td>
              
                <td style="padding:10px;border-bottom:1px solid #f1f5f9; white-space:nowrap;">
                  <!-- Deactivate / Reactivate -->
                  <form method="post" style="display:inline-block;margin:0;">
                    {% csrf_token %}
                    {% if sp.is_active %}
                      <input type="hidden" name="action" value="deactivate_staff">
                      <button type="submit"
                              name="staff_id" value="{{ sp.id }}"
                              style="padding:6px 10px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;cursor:pointer;font-weight:600;">
                        Deactivate
                      </button>
                    {% else %}
                      <input type="hidden" name="action" value="activate_staff">
                      <button type="submit"
                              name="staff_id" value="{{ sp.id }}"
                              style="padding:6px 10px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;cursor:pointer;font-weight:600;">
                        Activate
                      </button>
                    {% endif %}
                  </form>
              
                  <!-- Delete -->
                  <form method="post" style="display:inline-block;margin:0 0 0 8px;">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="delete_staff">
                    <button type="submit"
                            name="staff_id" value="{{ sp.id }}"
                            onclick="return confirm('Delete this staff account permanently?');"
                            style="padding:6px 10px;border-radius:10px;border:1px solid #fecaca;background:#fff;cursor:pointer;font-weight:700;color:#b91c1c;">
                      Delete
                    </button>
                  </form>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p style="margin:0;color:#6b7280;">No staff created yet.</p>
    {% endif %}
  </div>

</div>

<!-- Small form styling so Django widgets look decent -->
<style>
  input, select, textarea {
    width: 100%;
    padding: 10px;
    border-radius: 10px;
    border: 1px solid #e5e7eb;
    outline: none;
    font-size: 16px; /* prevents iOS zoom on focus */
  }
  input:focus, select:focus, textarea:focus {
    border-color: #93c5fd;
    box-shadow: 0 0 0 3px rgba(59,130,246,0.15);
  }
  textarea { min-height: 80px; }

  /* ---------- Mobile tweaks ---------- */
  @media (max-width: 700px) {
    .profile-grid-2 { grid-template-columns: 1fr !important; }
    .profile-grid-3 { grid-template-columns: 1fr !important; }
  }

  @media (max-width: 520px) {
    .profile-card { padding: 14px !important; }
    .profile-table th, .profile-table td { padding: 8px !important; font-size: 14px !important; }
  }
</style>

{% endblock %}