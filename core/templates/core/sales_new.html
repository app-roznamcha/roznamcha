{% extends "core/base.html" %}
{% block title %}New Sale{% endblock %}

{% block content %}
<div class="page sale-new-page">
  <style>
    .sale-new-page{
      max-width:1120px;
      margin:34px auto 64px;
      padding:0 18px;
      --line:#e2e8f0;
      --ink-900:#0f172a;
      --ink-700:#334155;
      --ink-500:#64748b;
      --primary:#2563eb;
      --primary-dark:#1d4ed8;
      --surface:#ffffff;
    }

    .sale-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      margin-bottom:18px;
      flex-wrap:wrap;
      gap:12px;
      border:1px solid var(--line);
      border-radius:18px;
      padding:18px 20px;
      background:
        radial-gradient(900px 260px at -20% -120%, #dbeafe 0%, transparent 58%),
        radial-gradient(700px 220px at 120% -110%, #dcfce7 0%, transparent 56%),
        var(--surface);
      box-shadow:0 10px 24px rgba(15,23,42,.07);
    }

    .sale-head-title{
      margin:0 0 4px;
      font-size:31px;
      font-weight:800;
      color:var(--ink-900);
      letter-spacing:-.02em;
    }

    .sale-head-sub{
      margin:0;
      font-size:15px;
      color:#475569;
      line-height:1.55;
      max-width:720px;
    }

    .sale-head-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .sale-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:10px 16px;
      min-width:146px;
      border-radius:12px;
      font-size:14px;
      font-weight:700;
      text-decoration:none;
      border:1px solid #cbd5e1;
      background:#f8fafc;
      color:#111827;
      white-space:nowrap;
      transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease;
      cursor:pointer;
    }

    .sale-btn:hover{
      transform:translateY(-1px);
      border-color:#94a3b8;
      box-shadow:0 8px 16px rgba(15,23,42,.08);
    }

    .sale-btn-primary{
      border-color:var(--primary-dark);
      background:linear-gradient(180deg,var(--primary),var(--primary-dark));
      color:#fff;
    }

    .sale-card{
      background:#fff;
      border-radius:16px;
      border:1px solid var(--line);
      padding:18px 20px 20px;
      box-shadow:0 8px 18px rgba(15,23,42,.06);
      margin-bottom:18px;
    }

    .sale-card-title{
      font-size:18px;
      font-weight:800;
      color:var(--ink-900);
      margin-bottom:10px;
    }

    .sale-field-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
      gap:12px;
    }

    .sale-card label{
      font-size:14px;
      color:var(--ink-700);
    }

    .sale-card input,
    .sale-card select,
    .sale-card textarea{
      border:1px solid #cbd5e1 !important;
      border-radius:10px !important;
      padding:8px 10px !important;
      font-size:14px !important;
      background:#fff !important;
      transition:border-color .14s ease, box-shadow .14s ease;
    }

    .sale-card input:focus,
    .sale-card select:focus,
    .sale-card textarea:focus{
      border-color:#93c5fd !important;
      box-shadow:0 0 0 3px rgba(37,99,235,.15);
      outline:none;
    }

    .sale-card input[readonly]{
      background:#f8fafc !important;
      color:#475569;
    }

    .items-top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:10px;
      flex-wrap:wrap;
      gap:10px;
    }

    .items-stats{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }

    .items-chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      border:1px solid var(--line);
      background:#f8fafc;
      color:#0f172a;
      font-size:13px;
      font-weight:700;
      border-radius:999px;
      padding:6px 10px;
    }

    .items-total{
      border-color:#bfdbfe;
      background:#eff6ff;
      color:#1d4ed8;
    }

    .table-wrap{
      border:1px solid #e5e7eb;
      border-radius:12px;
      overflow:auto;
      margin-bottom:10px;
      background:#fff;
    }

    #items-table th{
      position:sticky;
      top:0;
      z-index:1;
      background:#f8fafc !important;
      color:#334155;
      text-transform:uppercase;
      letter-spacing:.05em;
      font-size:12px !important;
      font-weight:700 !important;
    }

    #items-table tbody tr:hover{
      background:#f8fbff;
    }

    .items-actions{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      margin-top:10px;
    }

    .items-note{
      color:#64748b;
      font-size:12px;
      margin-left:auto;
    }

    .pay-radios{
      display:flex;
      flex-wrap:wrap;
      gap:16px;
      margin-bottom:12px;
      font-size:14px;
      padding:10px 12px;
      border:1px solid #e2e8f0;
      border-radius:10px;
      background:#f8fafc;
    }

    .pay-total{
      margin-bottom:10px;
      font-weight:700;
      font-size:15px;
      color:#0f172a;
    }

    .sale-form-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .sale-link-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:9px 14px;
      border-radius:12px;
      font-size:14px;
      font-weight:700;
      text-decoration:none;
      color:#1d4ed8;
      border:1px solid #dbeafe;
      background:#eff6ff;
    }

    @media (max-width: 700px){
      .sale-new-page{
        margin:22px auto 52px;
        padding:0 14px;
      }
      .sale-header{
        padding:16px;
      }
      .sale-head-title{
        font-size:25px;
      }
      .sale-btn,
      .sale-link-btn{
        width:100%;
      }
      .items-note{
        margin-left:0;
        width:100%;
      }
    }
  </style>

  {# ---------- Top Bar (Title + Buttons) ---------- #}
  <div class="sale-header">
    <div>
      {% if edit_mode %}
        <h1 id="pageTitle" data-mode="edit" class="sale-head-title" data-i18n="sale_edit_title">Edit Sale</h1>
      {% else %}
        <h1 id="pageTitle" data-mode="new" class="sale-head-title" data-i18n="sale_new_title">New Sale</h1>
      {% endif %}
      <p class="sale-head-sub" data-i18n="sale_subtitle">
        Create a new sales invoice, add items, and record payment from the customer.
      </p>
    </div>
    <div class="sale-head-actions">
      <a href="{% url 'dashboard' %}"
         class="sale-btn">
        <span data-i18n="go_dashboard">‚Üê Dashboard</span>
      </a>
      <a href="{% url 'sales_list' %}"
         class="sale-btn sale-btn-primary">
        <span data-i18n="sales_list_btn">üìÑ Sales List</span>
      </a>
    </div>
  </div>

  {# ---------- Error (if any) ---------- #}
  {% if error %}
    <div style="margin-bottom:16px;padding:10px 12px;border-radius:10px;
                font-size:14px;background:#fee2e2;color:#b91c1c;border:1px solid #fecaca;">
      {{ error }}
    </div>
  {% endif %}

  <form method="post">
    {% csrf_token %}

    {# ---------- Customer & Invoice Details Card ---------- #}
    <div class="sale-card">
      <div class="sale-card-title" data-i18n="customer_invoice_details">
        Customer &amp; Invoice Details
      </div>

      <div class="sale-field-grid">
        <label style="font-size:14px;display:flex;flex-direction:column;gap:4px;">
          <span data-i18n="customer_label">Customer</span>
          <select name="customer" required
                style="padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;">
          <option value="" data-i18n="select_customer_opt">-- Select Customer --</option>
          {% for c in customers %}
            <option value="{{ c.id }}"
                    {% if edit_mode and selected_customer_id == c.id|stringformat:"s" %}
                      selected
                    {% endif %}>
              {{ c.name }}
            </option>
          {% endfor %}
        </select>
        </label>

        <label style="font-size:14px;display:flex;flex-direction:column;gap:4px;">
          <span data-i18n="invoice_date_label">Invoice Date</span>
          <input type="date"
                 name="invoice_date"
                 value="{% if edit_mode %}{{ invoice.invoice_date|date:'Y-m-d' }}{% else %}{{ today }}{% endif %}"
                 style="padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;">
        </label>

        <label style="font-size:14px;display:flex;flex-direction:column;gap:4px;">
          <span data-i18n="invoice_number_label">Invoice #</span>
          <input type="text"
                 name="invoice_number"
                 value="{% if edit_mode %}{{ invoice.invoice_number }}{% else %}{{ suggested_invoice_number }}{% endif %}"
                 readonly
                 style="padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;background:#f9fafb;">
        </label>
      </div>

      <label style="margin-top:12px;display:block;font-size:14px;">
        <span style="display:block;margin-bottom:4px;" data-i18n="notes_label">Notes</span>
        <textarea name="notes"
                  rows="2"
                  style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;resize:vertical;">{% if edit_mode %}{{ invoice.notes }}{% endif %}</textarea>
      </label>
    </div>

    {# ---------- Items Card ---------- #}
    <div class="sale-card">
      <div class="items-top">
        <div class="sale-card-title" style="margin-bottom:0;" data-i18n="items_title">Items</div>
        <div class="items-stats">
          <div class="items-chip"><span>Lines</span>: <span id="items-line-count">0</span></div>
          <div class="items-chip"><span>Total Qty</span>: <span id="items-total-qty">0.000</span></div>
          <div id="items-total-display" class="items-chip items-total">
          <span data-i18n="total_sale">Total Sale</span>: <span data-i18n="rs">Rs</span> <span id="items-total-amount">0.00</span>
          </div>
        </div>
      </div>

      <div class="table-wrap">
        <table id="items-table"
                style="border-collapse:collapse;width:100%;min-width:980px;">
          <thead>
            <tr>
              <th style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;background:#f9fafb;text-align:left;font-weight:600;" data-i18n="th_product">Product</th>
              <th style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;background:#f9fafb;text-align:left;font-weight:600;" data-i18n="th_unit">Unit</th>
              <th style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;background:#f9fafb;text-align:right;font-weight:600;" data-i18n="th_available_stock">
                Available Stock
              </th>
              <th style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;background:#f9fafb;text-align:right;font-weight:600;" data-i18n="th_unit_price">Unit Price</th>
              <th style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;background:#f9fafb;text-align:right;font-weight:600;" data-i18n="th_quantity">Quantity</th>
              <th style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;background:#f9fafb;text-align:right;font-weight:600;" data-i18n="th_total_price">Total Price</th>
              <th style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;background:#f9fafb;text-align:center;font-weight:600;"></th>
            </tr>
          </thead>
          <tbody>
            {# --- If editing: show existing items --- #}
            {% if edit_mode %}
          
              {% for item in items %}
                {% with forloop.counter as idx %}
                <tr data-row-index="{{ idx }}"
                    data-unit-code="{{ item.product.unit }}"
                    data-packing-type="{{ item.product.packing_type|default:'NONE' }}"
                    data-pieces-per-pack="{{ item.product.pieces_per_pack|default:1 }}"
                    data-packing-label="{{ item.product.get_packing_type_display|default:'' }}">
          
                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;">
                    <select name="product_{{ idx }}"
                            class="product-select"
                            style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;">
                      <option value="" data-i18n="select_opt">-- Select --</option>
                      {% for p in products %}
                        <option
                          value="{{ p.id }}"
                          data-unit="{{ p.unit }}"
                          data-price="{{ p.sale_price_per_unit|floatformat:2 }}"
                          data-stock="{{ p.current_stock|floatformat:3 }}"
                          data-unit-label="{{ p.get_unit_display }}"
                          data-packing-type="{{ p.packing_type|default:'NONE' }}"
                          data-pieces-per-pack="{{ p.pieces_per_pack|default:1 }}"
                          data-packing-label="{{ p.get_packing_type_display|default:'' }}"
                          {% if p.id == item.product.id %}selected{% endif %}>
                          {{ p.code }} - {{ p.name }}
                        </option>
                      {% endfor %}
                    </select>
                  </td>
          
                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;">
                    <select name="unit_{{ idx }}"
                            class="unit-select"
                            style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;">
                      <option value="UNIT"
                              {% if item.unit_mode|default:"UNIT" == "UNIT" %}selected{% endif %}>
                        <span data-i18n="base_prefix">Base</span> {{ item.product.get_unit_display }}
                      </option>
                      {% if item.product.packing_type != "NONE" and item.product.pieces_per_pack > 1 %}
                        <option value="PACK"
                                {% if item.unit_mode|default:"UNIT" == "PACK" %}selected{% endif %}>
                          {{ item.product.get_packing_type_display }} ({{ item.product.pieces_per_pack }} √ó {{ item.product.get_unit_display }})
                        </option>
                      {% endif %}
                    </select>
                  </td>
          
                  {# ‚úÖ Available Stock column #}
                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:right;white-space:nowrap;">
                    <span class="stock-display" style="font-weight:600;color:#0f172a;">
                      {{ item.product.current_stock|floatformat:3 }} {{ item.product.get_unit_display }}
                    </span>
                  </td>
          
                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:right;">
                    <input type="number"
                           step="0.01"
                           name="unit_price_{{ idx }}"
                           class="price-input"
                           value="{{ item.unit_price|floatformat:2 }}"
                           style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;text-align:right;">
                  </td>
          
                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:right;">
                    <input type="number"
                          step="0.001"
                          class="qty-display-input"
                          value="{{ item.quantity_units|floatformat:3 }}"
                          style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;text-align:right;">
                    <input type="hidden"
                          name="quantity_{{ idx }}"
                          class="qty-hidden-input"
                          value="{{ item.quantity_units|floatformat:3 }}">
                  </td>
          
                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:right;">
                    <span data-i18n="rs">Rs</span> <span class="line-total">0.00</span>
                  </td>
          
                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:center;">
                    <button type="button"
                            class="btn btn-sm btn-danger"
                            onclick="removeRow(this)"
                            style="padding:4px 9px;border-radius:999px;font-size:13px;">
                      ‚úï
                    </button>
                  </td>
                </tr>
                {% endwith %}
              {% endfor %}
          
              {# ‚úÖ add extra blank rows for new items (EDIT MODE) #}
              {% for _ in "12" %}
                {% with items|length|add:forloop.counter as idx %}
                <tr data-row-index="{{ idx }}"
                    data-unit-code=""
                    data-packing-type="NONE"
                    data-pieces-per-pack="1"
                    data-packing-label="">
                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;">
                    <select name="product_{{ idx }}"
                            class="product-select"
                            style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;">
                      <option value="" data-i18n="select_opt">-- Select --</option>
                      {% for p in products %}
                        <option
                          value="{{ p.id }}"
                          data-unit="{{ p.unit }}"
                          data-price="{{ p.sale_price_per_unit|floatformat:2 }}"
                          data-stock="{{ p.current_stock|floatformat:3 }}"
                          data-unit-label="{{ p.get_unit_display }}"
                          data-packing-type="{{ p.packing_type|default:'NONE' }}"
                          data-pieces-per-pack="{{ p.pieces_per_pack|default:1 }}"
                          data-packing-label="{{ p.get_packing_type_display|default:'' }}">
                          {{ p.code }} - {{ p.name }}
                        </option>
                      {% endfor %}
                    </select>
                  </td>
          
                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;">
                    <select name="unit_{{ idx }}"
                            class="unit-select"
                            style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;">
                      <option value="" data-i18n="unit_opt">-- Unit --</option>
                    </select>
                  </td>
          
                  {# ‚úÖ Stock cell exists (JS will fill it when product selected) #}
                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:right;white-space:nowrap;">
                    <span class="stock-display" style="font-weight:600;color:#0f172a;">‚Äî</span>
                  </td>
          
                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:right;">
                    <input type="number"
                           step="0.01"
                           name="unit_price_{{ idx }}"
                           class="price-input"
                           style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;text-align:right;">
                  </td>
          
                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:right;">
                    <input type="number"
                           step="0.001"
                           class="qty-display-input"
                           placeholder="Qty"
                           style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;text-align:right;">
                    <input type="hidden"
                           name="quantity_{{ idx }}"
                           class="qty-hidden-input">
                  </td>
          
                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:right;">
                    <span data-i18n="rs">Rs</span> <span class="line-total">0.00</span>
                  </td>
          
                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:center;">
                    <button type="button"
                            class="btn btn-sm btn-danger"
                            onclick="removeRow(this)"
                            style="padding:4px 9px;border-radius:999px;font-size:13px;">
                      ‚úï
                    </button>
                  </td>
                </tr>
                {% endwith %}
              {% endfor %}
          
            {% else %}
          
              {# ‚úÖ NEW SALE: 5 blank rows #}
              {% for _ in "12345" %}
                {% with forloop.counter as idx %}
                <tr data-row-index="{{ idx }}"
                    data-unit-code=""
                    data-packing-type="NONE"
                    data-pieces-per-pack="1"
                    data-packing-label="">
                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;">
                    <select name="product_{{ idx }}"
                            class="product-select"
                            style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;">
                      <option value="" data-i18n="select_opt">-- Select --</option>
                      {% for p in products %}
                        <option
                          value="{{ p.id }}"
                          data-unit="{{ p.unit }}"
                          data-price="{{ p.sale_price_per_unit|floatformat:2 }}"
                          data-stock="{{ p.current_stock|floatformat:3 }}"
                          data-unit-label="{{ p.get_unit_display }}"
                          data-packing-type="{{ p.packing_type|default:'NONE' }}"
                          data-pieces-per-pack="{{ p.pieces_per_pack|default:1 }}"
                          data-packing-label="{{ p.get_packing_type_display|default:'' }}">
                          {{ p.code }} - {{ p.name }}
                        </option>
                      {% endfor %}
                    </select>
                  </td>
          
                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;">
                    <select name="unit_{{ idx }}"
                            class="unit-select"
                            style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;">
                      <option value="" data-i18n="unit_opt">-- Unit --</option>
                    </select>
                  </td>
          
                  {# ‚úÖ Stock column #}
                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:right;white-space:nowrap;">
                    <span class="stock-display" style="font-weight:600;color:#0f172a;">‚Äî</span>
                  </td>
          
                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:right;">
                    <input type="number"
                           step="0.01"
                           name="unit_price_{{ idx }}"
                           class="price-input"
                           style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;text-align:right;">
                  </td>
          
                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:right;">
                    <input type="number"
                           step="0.001"
                           class="qty-display-input"
                           placeholder="Qty"
                           style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;text-align:right;">
                    <input type="hidden"
                           name="quantity_{{ idx }}"
                           class="qty-hidden-input">
                  </td>
          
                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:right;">
                    <span data-i18n="rs">Rs</span> <span class="line-total">0.00</span>
                  </td>
          
                  <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:center;">
                    <button type="button"
                            class="btn btn-sm btn-danger"
                            onclick="removeRow(this)"
                            style="padding:4px 9px;border-radius:999px;font-size:13px;">
                      ‚úï
                    </button>
                  </td>
                </tr>
                {% endwith %}
              {% endfor %}
          
            {% endif %}
          </tbody>
        </table>
      </div>

      <div class="items-actions">
        <button type="button" class="sale-btn" onclick="addRow()">
          <span data-i18n="add_item_row">+ Add Item Row</span>
        </button>
        <button type="button" class="sale-btn" onclick="removeEmptyRows()">
          Remove Empty Rows
        </button>
        <div class="items-note">Shortcut: <strong>Alt + =</strong> adds a row quickly</div>
      </div>
    </div>

    {# ---------- Payment Card ---------- #}
    <div class="sale-card">
      <div class="sale-card-title" style="margin-bottom:8px;" data-i18n="payment_title">
        Payment
      </div>

      <p class="pay-total">
        <span data-i18n="total_sale">Total Sale</span>: <span data-i18n="rs">Rs</span> <span id="payment-total-amount">0.00</span>
      </p>

      <div class="field-group pay-radios">
        <label>
          <input type="radio" name="payment_type" value="FULL"
                 {% if edit_mode and invoice.payment_type == 'FULL' %}checked{% endif %}>
          <span data-i18n="pay_full">Full Payment (Cash/Bank)</span>
        </label>
        <label>
          <input type="radio" name="payment_type" value="PARTIAL"
                 {% if edit_mode and invoice.payment_type == 'PARTIAL' %}checked{% endif %}>
          <span data-i18n="pay_partial">Partial Payment</span>
        </label>
        <label>
          <input type="radio" name="payment_type" value="CREDIT"
                 {% if not edit_mode or invoice.payment_type == 'CREDIT' %}checked{% endif %}>
          <span data-i18n="pay_credit">Credit (Customer will pay later)</span>
        </label>
      </div>

      <div id="payment-extra-fields" style="margin-top:4px;display:none;">
        <label style="display:flex;flex-direction:column;gap:4px;font-size:14px;">
          <span data-i18n="amount_received_now">Amount Received Now</span>
          <input type="number"
                 step="0.01"
                 name="payment_amount"
                 id="payment-amount-input"
                 value="{% if edit_mode %}{{ invoice.payment_amount|floatformat:2 }}{% else %}0.00{% endif %}"
                 style="max-width:260px;padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;">
        </label>
        <p class="text-muted" style="margin:4px 0 10px;font-size:13px;color:#6b7280;" data-i18n="pay_help">
          For <strong>Full Payment</strong> this will be auto-filled from Total Sale and locked.
          For <strong>Partial</strong>, you can type a smaller amount.
        </p>

        <label style="display:flex;flex-direction:column;gap:4px;font-size:14px;max-width:320px;">
          <span data-i18n="payment_account_label">Payment Account</span>
          <select name="payment_account"
                  id="payment-account-select"
                  style="padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;">
            <option value="" data-i18n="select_cash_bank">-- Select Cash/Bank Account --</option>
            {% for acc in accounts %}
              <option value="{{ acc.id }}"
                      {% if edit_mode and invoice.payment_account and invoice.payment_account.id == acc.id %}
                        selected
                      {% endif %}>
                {{ acc.code }} - {{ acc.name }}
              </option>
            {% endfor %}
          </select>
        </label>
        <p class="text-muted" style="margin-top:4px;font-size:13px;color:#6b7280;" data-i18n="pay_account_required">
          Required for full or partial cash/bank payments.
        </p>
      </div>

      <p id="credit-note"
         class="text-muted"
         style="margin-top:8px;font-size:13px;color:#6b7280;" data-i18n="credit_note">
        For <strong>CREDIT</strong> sales, no payment is recorded now and the full amount
        will appear as receivable from the customer.
      </p>
    </div>

    {# ---------- Form Actions ---------- #}
    <div class="sale-form-actions">
      <button type="submit"
              class="sale-btn sale-btn-primary">
        {% if edit_mode %}
          <span data-i18n="update_invoice">üíæ Update Invoice</span>
        {% else %}
          <span data-i18n="save_sale_unposted">üíæ Save Sale (Unposted)</span>
        {% endif %}
      </button>
      <a href="{% url 'sales_list' %}"
         class="sale-link-btn">
        <span data-i18n="cancel_btn">Cancel</span>
      </a>
    </div>

  </form>
</div>

{# -------- JS: product meta + totals + payment behaviour -------- #}
<script>
/* ===========================
   Page i18n (adds Urdu only)
   Uses global base.html applyLang
   =========================== */
window.ROZ_I18N = window.ROZ_I18N || { en: {}, ur: {} };

Object.assign(window.ROZ_I18N.en, {
  sale_new_title: "New Sale",
  sale_edit_title: "Edit Sale",
  sale_subtitle: "Create a new sales invoice, add items, and record payment from the customer.",

  go_dashboard: "‚Üê Dashboard",
  sales_list_btn: "üìÑ Sales List",

  customer_invoice_details: "Customer & Invoice Details",
  customer_label: "Customer",
  select_customer_opt: "-- Select Customer --",
  invoice_date_label: "Invoice Date",
  invoice_number_label: "Invoice #",
  notes_label: "Notes",

  items_title: "Items",
  total_sale: "Total Sale",
  rs: "Rs",

  th_product: "Product",
  th_unit: "Unit",
  th_available_stock: "Available Stock",
  th_unit_price: "Unit Price",
  th_quantity: "Quantity",
  th_total_price: "Total Price",

  select_opt: "-- Select --",
  unit_opt: "-- Unit --",
  base_prefix: "Base",

  add_item_row: "+ Add Item Row",

  payment_title: "Payment",
  pay_full: "Full Payment (Cash/Bank)",
  pay_partial: "Partial Payment",
  pay_credit: "Credit (Customer will pay later)",

  amount_received_now: "Amount Received Now",
  pay_help: "For Full Payment this will be auto-filled from Total Sale and locked. For Partial, you can type a smaller amount.",
  payment_account_label: "Payment Account",
  select_cash_bank: "-- Select Cash/Bank Account --",
  pay_account_required: "Required for full or partial cash/bank payments.",
  credit_note: "For CREDIT sales, no payment is recorded now and the full amount will appear as receivable from the customer.",

  update_invoice: "üíæ Update Invoice",
  save_sale_unposted: "üíæ Save Sale (Unposted)",
  cancel_btn: "Cancel",
});

Object.assign(window.ROZ_I18N.ur, {
  sale_new_title: "ŸÜÿ¶€å ÿ≥€åŸÑ",
  sale_edit_title: "ÿ≥€åŸÑ ŸÖ€å⁄∫ ÿ™ÿ±ŸÖ€åŸÖ",
  sale_subtitle: "ŸÜ€åÿß ÿ≥€åŸÑÿ≤ ÿßŸÜŸàÿßÿ¶ÿ≥ ÿ®ŸÜÿßÿ¶€å⁄∫ÿå ÿ¢ÿ¶ŸπŸÖÿ≤ ÿ¥ÿßŸÖŸÑ ⁄©ÿ±€å⁄∫ÿå ÿßŸàÿ± ⁄©ÿ≥ŸπŸÖÿ± ÿ≥€í ÿßÿØÿßÿ¶€å⁄Ø€å ÿ±€å⁄©ÿßÿ±⁄à ⁄©ÿ±€å⁄∫€î",

  go_dashboard: "‚Üê ⁄à€åÿ¥ ÿ®Ÿàÿ±⁄à",
  sales_list_btn: "üìÑ ÿ≥€åŸÑÿ≤ ŸÑÿ≥Ÿπ",

  customer_invoice_details: "⁄©ÿ≥ŸπŸÖÿ± ÿßŸàÿ± ÿßŸÜŸàÿßÿ¶ÿ≥ ⁄©€å ÿ™ŸÅÿµ€åŸÑ",
  customer_label: "⁄©ÿ≥ŸπŸÖÿ±",
  select_customer_opt: "-- ⁄©ÿ≥ŸπŸÖÿ± ŸÖŸÜÿ™ÿÆÿ® ⁄©ÿ±€å⁄∫ --",
  invoice_date_label: "ÿßŸÜŸàÿßÿ¶ÿ≥ ÿ™ÿßÿ±€åÿÆ",
  invoice_number_label: "ÿßŸÜŸàÿßÿ¶ÿ≥ ŸÜŸÖÿ®ÿ±",
  notes_label: "ŸÜŸàŸπÿ≥",

  items_title: "ÿ¢ÿ¶ŸπŸÖÿ≤",
  total_sale: "⁄©ŸÑ ÿ≥€åŸÑ",
  rs: "ÿ±ŸàŸæ€í",

  th_product: "Ÿæÿ±Ÿà⁄à⁄©Ÿπ",
  th_unit: "€åŸàŸÜŸπ",
  th_available_stock: "ŸÖŸàÿ¨ŸàÿØ€Å ÿßÿ≥Ÿπÿß⁄©",
  th_unit_price: "ŸÅ€å €åŸàŸÜŸπ ŸÇ€åŸÖÿ™",
  th_quantity: "ŸÖŸÇÿØÿßÿ±",
  th_total_price: "⁄©ŸÑ ŸÇ€åŸÖÿ™",

  select_opt: "-- ŸÖŸÜÿ™ÿÆÿ® ⁄©ÿ±€å⁄∫ --",
  unit_opt: "-- €åŸàŸÜŸπ --",
  base_prefix: "ÿ®ŸÜ€åÿßÿØ€å",

  add_item_row: "+ ŸÜÿ¶€å ŸÑÿßÿ¶ŸÜ ÿ¥ÿßŸÖŸÑ ⁄©ÿ±€å⁄∫",

  payment_title: "ÿßÿØÿßÿ¶€å⁄Ø€å",
  pay_full: "ŸÖ⁄©ŸÖŸÑ ÿßÿØÿßÿ¶€å⁄Ø€å (⁄©€åÿ¥/ÿ®€åŸÜ⁄©)",
  pay_partial: "ÿ¨ÿ≤Ÿà€å ÿßÿØÿßÿ¶€å⁄Ø€å",
  pay_credit: "ÿßÿØ⁄æÿßÿ± (⁄©ÿ≥ŸπŸÖÿ± ÿ®ÿπÿØ ŸÖ€å⁄∫ ÿØ€í ⁄Øÿß)",

  amount_received_now: "ÿßÿ®⁄æ€å ŸàÿµŸàŸÑ ÿ±ŸÇŸÖ",
  pay_help: "ŸÖ⁄©ŸÖŸÑ ÿßÿØÿßÿ¶€å⁄Ø€å ŸÖ€å⁄∫ €å€Å ⁄©ŸÑ ÿ≥€åŸÑ ⁄©€í ŸÖÿ∑ÿßÿ®ŸÇ ÿÆŸàÿØ ÿ®⁄æÿ± ÿ¨ÿßÿ¶€í ⁄Øÿß ÿßŸàÿ± ŸÑÿß⁄© €ÅŸà ÿ¨ÿßÿ¶€í ⁄Øÿß€î ÿ¨ÿ≤Ÿà€å ÿßÿØÿßÿ¶€å⁄Ø€å ŸÖ€å⁄∫ ÿ¢Ÿæ ⁄©ŸÖ ÿ±ŸÇŸÖ ŸÑ⁄©⁄æ ÿ≥⁄©ÿ™€í €Å€å⁄∫€î",
  payment_account_label: "ÿßÿØÿßÿ¶€å⁄Ø€å ÿß⁄©ÿßÿ§ŸÜŸπ",
  select_cash_bank: "-- ⁄©€åÿ¥/ÿ®€åŸÜ⁄© ÿß⁄©ÿßÿ§ŸÜŸπ ŸÖŸÜÿ™ÿÆÿ® ⁄©ÿ±€å⁄∫ --",
  pay_account_required: "ŸÖ⁄©ŸÖŸÑ €åÿß ÿ¨ÿ≤Ÿà€å ⁄©€åÿ¥/ÿ®€åŸÜ⁄© ÿßÿØÿßÿ¶€å⁄Ø€å ⁄©€í ŸÑ€å€í ÿ∂ÿ±Ÿàÿ±€å €Å€í€î",
  credit_note: "ÿßÿØ⁄æÿßÿ± ÿ≥€åŸÑ ŸÖ€å⁄∫ ÿßÿ®⁄æ€å ⁄©Ÿàÿ¶€å ÿßÿØÿßÿ¶€å⁄Ø€å ÿ±€å⁄©ÿßÿ±⁄à ŸÜ€Å€å⁄∫ €ÅŸà⁄Ø€å ÿßŸàÿ± ŸæŸàÿ±€å ÿ±ŸÇŸÖ ⁄©ÿ≥ŸπŸÖÿ± ÿ≥€í ŸàÿµŸàŸÑ€å ŸÖ€å⁄∫ ÿ¢ÿ¶€í ⁄Ø€å€î",

  update_invoice: "üíæ ÿßŸÜŸàÿßÿ¶ÿ≥ ÿßŸæ⁄à€åŸπ ⁄©ÿ±€å⁄∫",
  save_sale_unposted: "üíæ ÿ≥€åŸÑ ŸÖÿ≠ŸÅŸàÿ∏ ⁄©ÿ±€å⁄∫ (ÿ∫€åÿ± ŸæŸàÿ≥Ÿπ⁄à)",
  cancel_btn: "⁄©€åŸÜÿ≥ŸÑ",
});

/* Apply current saved language using base.html function */
document.addEventListener("DOMContentLoaded", () => {
  if (window.applyLang) {
    window.applyLang(localStorage.getItem("roz_lang") || "en");
  }

  // Ensure title matches mode if needed (keeps Django logic intact)
  const t = document.getElementById("pageTitle");
  if (t) {
    const mode = t.getAttribute("data-mode") || "new";
    const lang = localStorage.getItem("roz_lang") || "en";
    const key = (mode === "edit") ? "sale_edit_title" : "sale_new_title";
    const val = (window.ROZ_I18N[lang] || {})[key];
    if (val) t.textContent = val;
  }

  // Re-apply on language change across tabs
  window.addEventListener("storage", function(e){
    if (e.key === "roz_lang" && window.applyLang) {
      window.applyLang(localStorage.getItem("roz_lang") || "en");
      const t2 = document.getElementById("pageTitle");
      if (t2) {
        const mode2 = t2.getAttribute("data-mode") || "new";
        const lang2 = localStorage.getItem("roz_lang") || "en";
        const key2 = (mode2 === "edit") ? "sale_edit_title" : "sale_new_title";
        const val2 = (window.ROZ_I18N[lang2] || {})[key2];
        if (val2) t2.textContent = val2;
      }
    }
  });
});

let salesRowCounter = 5; // kept, but we‚Äôll compute the real index from DOM when adding rows

const UNIT_LABELS = {
  "BAG": "Bag",
  "KG": "Kilogram",
  "LITRE": "Litre",
  "UNIT": "Unit / Piece"
};

// Helper: format number to 2 decimal places
function fmt(amount) {
  const n = parseFloat(amount || 0) || 0;
  return n.toFixed(2);
}

function recalcGrandTotal() {
  const rows = document.querySelectorAll('#items-table tbody tr');
  let itemsTotal = 0;
  let totalQty = 0;
  let lineCount = 0;

  rows.forEach(tr => {
    const totalSpan = tr.querySelector('.line-total');
    const lineVal = parseFloat(totalSpan && totalSpan.textContent || 0) || 0;
    itemsTotal += lineVal;

    const product = tr.querySelector('.product-select');
    const qtyHidden = tr.querySelector('.qty-hidden-input');
    const qtyVal = parseFloat(qtyHidden && qtyHidden.value || 0) || 0;
    if (product && product.value) {
      lineCount += 1;
      totalQty += qtyVal;
    }
  });

  const grandTotal = itemsTotal;

  document.getElementById('items-total-amount').textContent = fmt(grandTotal);
  document.getElementById('payment-total-amount').textContent = fmt(grandTotal);
  const linesNode = document.getElementById('items-line-count');
  const qtyNode = document.getElementById('items-total-qty');
  if (linesNode) linesNode.textContent = String(lineCount);
  if (qtyNode) qtyNode.textContent = (totalQty || 0).toFixed(3);

  updatePaymentAmount(grandTotal);
}

function getSelectedPaymentType() {
  const radios = document.querySelectorAll('input[name="payment_type"]');
  let val = 'CREDIT';
  radios.forEach(r => {
    if (r.checked) val = r.value;
  });
  return val;
}

function updatePaymentAmount(grandTotal) {
  const paymentAmountInput = document.getElementById('payment-amount-input');
  if (!paymentAmountInput) return;

  const paymentType = getSelectedPaymentType();

  if (paymentType === 'FULL') {
    paymentAmountInput.value = fmt(grandTotal);
    paymentAmountInput.readOnly = true;
  } else if (paymentType === 'PARTIAL') {
    if (!paymentAmountInput.value || parseFloat(paymentAmountInput.value) === 0) {
      paymentAmountInput.value = fmt(grandTotal);
    }
    paymentAmountInput.readOnly = false;
  } else { // CREDIT
    paymentAmountInput.value = fmt(0);
    paymentAmountInput.readOnly = true;
  }
}

// -------- Row sync logic (similar to purchase) --------
function syncRow(tr) {
  const productSelect = tr.querySelector('.product-select');
  const unitSelect = tr.querySelector('.unit-select');
  const priceInput = tr.querySelector('.price-input');
  const qtyDisplayInput = tr.querySelector('.qty-display-input');
  const qtyHiddenInput = tr.querySelector('.qty-hidden-input');
  const totalSpan = tr.querySelector('.line-total');

  if (!productSelect || !unitSelect || !priceInput || !qtyDisplayInput || !qtyHiddenInput || !totalSpan) {
    return;
  }

  const price = parseFloat(priceInput.value || 0) || 0;
  const displayQty = parseFloat(qtyDisplayInput.value || 0) || 0;

  const unitMode = unitSelect.value || "UNIT";  // "UNIT" = base unit, "PACK" = carton/bag/container/bundle
  const piecesPerPack = parseFloat(tr.dataset.piecesPerPack || "1") || 1;

  let multiplier = 1;
  if (unitMode === "PACK") {
    multiplier = piecesPerPack;
  }

  const baseQty = displayQty * multiplier;

  if (baseQty > 0) {
    qtyHiddenInput.value = baseQty.toFixed(3);
  } else {
    qtyHiddenInput.value = "";
  }

  const lineTotal = baseQty * price;
  totalSpan.textContent = fmt(lineTotal);
}

// When product changes: set price, packing metadata, and rebuild Unit dropdown
function handleProductChange(selectEl) {
  const tr = selectEl.closest('tr');
  const unitSelect = tr.querySelector('.unit-select');
  const priceInput = tr.querySelector('.price-input');

  const opt = selectEl.selectedOptions[0];

  // reset row packing metadata
  tr.dataset.unitCode = "";
  tr.dataset.packingType = "NONE";
  tr.dataset.piecesPerPack = "1";
  tr.dataset.packingLabel = "";

  unitSelect.innerHTML = '<option value="">-- Unit --</option>';

  if (opt) {
    const unitCode = opt.dataset.unit || "";
    const basePrice = opt.dataset.price || "";
    const packingType = opt.dataset.packingType || "NONE";
    const piecesPerPack = opt.dataset.piecesPerPack || "1";
    const packingLabel = opt.dataset.packingLabel || "";

    tr.dataset.unitCode = unitCode;
    tr.dataset.packingType = packingType;
    tr.dataset.piecesPerPack = piecesPerPack;
    tr.dataset.packingLabel = packingLabel;

    priceInput.value = basePrice;

    if (unitCode) {
      const baseLabel = UNIT_LABELS[unitCode] || "Unit";
      const baseOpt = document.createElement('option');
      baseOpt.value = "UNIT";
      baseOpt.textContent = `Base ${baseLabel}`;
      unitSelect.appendChild(baseOpt);
    }

    const ppNum = parseFloat(piecesPerPack || "1") || 1;
    if (packingType !== "NONE" && ppNum > 1) {
      const packOpt = document.createElement('option');
      packOpt.value = "PACK";
      const unitLabel = UNIT_LABELS[unitCode] || "Unit";
      packOpt.textContent = `${packingLabel} (${ppNum} √ó ${unitLabel})`;
      unitSelect.appendChild(packOpt);
    }

    // for changed product, default to base unit
    unitSelect.value = "UNIT";
  }

  syncRow(tr);
  updateStockDisplay(tr);
  recalcGrandTotal();
}

function handleQtyOrPriceChange(inputEl) {
  const tr = inputEl.closest('tr');
  syncRow(tr);
  recalcGrandTotal();
}

function handleUnitChange(selectEl) {
  const tr = selectEl.closest('tr');
  syncRow(tr);
  updateStockDisplay(tr);
  recalcGrandTotal();
}

function addRow() {
  const tbody = document.querySelector('#items-table tbody');
  const lastRow = tbody.querySelector('tr:last-child');

  let nextIndex = 1;
  if (lastRow) {
    nextIndex = (parseInt(lastRow.dataset.rowIndex || "0", 10) || 0) + 1;
  }

  const row = document.createElement('tr');
  row.setAttribute('data-row-index', nextIndex);
  row.setAttribute('data-unit-code', '');
  row.setAttribute('data-packing-type', 'NONE');
  row.setAttribute('data-pieces-per-pack', '1');
  row.setAttribute('data-packing-label', '');

  // ‚úÖ MUST MATCH HEADER: 7 tds (Product, Unit, Stock, Unit Price, Qty, Total, X)
  row.innerHTML = `
    <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;">
      <select name="product_${nextIndex}" class="product-select"
              style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;">
        <option value="">-- Select --</option>
        {% for p in products %}
          <option
            value="{{ p.id }}"
            data-unit="{{ p.unit }}"
            data-price="{{ p.sale_price_per_unit|floatformat:2 }}"
            data-stock="{{ p.current_stock|floatformat:3 }}"
            data-unit-label="{{ p.get_unit_display }}"
            data-packing-type="{{ p.packing_type|default:'NONE' }}"
            data-pieces-per-pack="{{ p.pieces_per_pack|default:1 }}"
            data-packing-label="{{ p.get_packing_type_display|default:'' }}">
            {{ p.code }} - {{ p.name }}
          </option>
        {% endfor %}
      </select>
    </td>

    <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;">
      <select name="unit_${nextIndex}" class="unit-select"
              style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;">
        <option value="">-- Unit --</option>
      </select>
    </td>

    <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:right;white-space:nowrap;">
      <span class="stock-display" style="font-weight:600;color:#0f172a;">‚Äî</span>
    </td>

    <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:right;">
      <input type="number"
       step="0.01"
       name="unit_price_${nextIndex}"
       class="price-input"
       style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;text-align:right;">
    </td>

    <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:right;">
      <input type="number"
             step="0.001"
             class="qty-display-input"
             placeholder="Qty"
             style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;text-align:right;">
      <input type="hidden"
             name="quantity_${nextIndex}"
             class="qty-hidden-input">
    </td>

    <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:right;">
      Rs <span class="line-total">0.00</span>
    </td>

    <td style="border-bottom:1px solid #e5e7eb;padding:7px 9px;font-size:15px;text-align:center;">
      <button type="button"
              class="btn btn-sm btn-danger"
              onclick="removeRow(this)"
              style="padding:4px 9px;border-radius:999px;font-size:13px;">
        ‚úï
      </button>
    </td>
  `;

  tbody.appendChild(row);
  attachRowEvents(row);
  syncRow(row);
  updateStockDisplay(row);
  recalcGrandTotal();
}

function removeRow(btn) {
  const tr = btn.closest('tr');
  tr.parentNode.removeChild(tr);
  recalcGrandTotal();
}

function removeEmptyRows() {
  const rows = Array.from(document.querySelectorAll('#items-table tbody tr'));
  rows.forEach((tr) => {
    const product = tr.querySelector('.product-select');
    const qtyDisplay = tr.querySelector('.qty-display-input');
    const priceInput = tr.querySelector('.price-input');
    const hasProduct = !!(product && product.value);
    const qty = parseFloat(qtyDisplay && qtyDisplay.value || 0) || 0;
    const price = parseFloat(priceInput && priceInput.value || 0) || 0;
    if (!hasProduct && qty <= 0 && price <= 0) {
      tr.remove();
    }
  });
  recalcGrandTotal();
}

// ---- Payment section behaviour ----
function updatePaymentVisibility() {
  const type = getSelectedPaymentType();
  const extra = document.getElementById('payment-extra-fields');
  const creditNote = document.getElementById('credit-note');
  const accountSelect = document.getElementById('payment-account-select');

  if (type === 'CREDIT') {
    if (extra) extra.style.display = 'none';
    if (creditNote) creditNote.style.display = 'block';
    if (accountSelect) {
      accountSelect.value = '';
    }
  } else {
    if (extra) extra.style.display = 'block';
    if (creditNote) creditNote.style.display = 'none';
  }

  const currentTotal = parseFloat(document.getElementById('payment-total-amount').textContent || 0) || 0;
  updatePaymentAmount(currentTotal);
}

function attachRowEvents(tr) {
  const productSelect = tr.querySelector('.product-select');
  const priceInput = tr.querySelector('.price-input');
  const qtyDisplayInput = tr.querySelector('.qty-display-input');
  const unitSelect = tr.querySelector('.unit-select');

  if (productSelect) {
    productSelect.addEventListener('change', () => handleProductChange(productSelect));
  }
  if (priceInput) {
    priceInput.addEventListener('input', () => handleQtyOrPriceChange(priceInput));
  }
  if (qtyDisplayInput) {
    qtyDisplayInput.addEventListener('input', () => handleQtyOrPriceChange(qtyDisplayInput));
  }
  if (unitSelect) {
    unitSelect.addEventListener('change', () => handleUnitChange(unitSelect));
  }
}

function updateStockDisplay(tr) {
  const stockSpan = tr.querySelector('.stock-display');
  const productSelect = tr.querySelector('.product-select');
  const unitSelect = tr.querySelector('.unit-select');

  if (!stockSpan || !productSelect) return;

  const opt = productSelect.selectedOptions[0];
  if (!opt || !opt.value) {
    stockSpan.textContent = "‚Äî";
    return;
  }

  const baseStock = parseFloat(opt.dataset.stock || "0") || 0;
  const unitLabel = opt.dataset.unitLabel || "Unit";

  const piecesPerPack = parseFloat(tr.dataset.piecesPerPack || "1") || 1;
  const packingType = tr.dataset.packingType || "NONE";
  const packingLabel = tr.dataset.packingLabel || "";

  const mode = (unitSelect && unitSelect.value) ? unitSelect.value : "UNIT";

  // Default: show base stock
  let text = `${baseStock.toFixed(3)} ${unitLabel}`;

  // If user selected PACK and packing exists, also show packs available
  if (mode === "PACK" && packingType !== "NONE" && piecesPerPack > 1) {
    const packs = baseStock / piecesPerPack;
    text = `${packs.toFixed(3)} ${packingLabel}  (${baseStock.toFixed(3)} ${unitLabel})`;
  }

  stockSpan.textContent = text;
}

document.addEventListener('DOMContentLoaded', function() {
  // Attach events to all existing rows and compute initial totals
  document.querySelectorAll('#items-table tbody tr').forEach(tr => {
    attachRowEvents(tr);
    syncRow(tr);  // so that existing lines (when editing) get proper totals
    updateStockDisplay(tr);
  });

  const paymentRadios = document.querySelectorAll('input[name="payment_type"]');
  paymentRadios.forEach(r => r.addEventListener('change', updatePaymentVisibility));

  recalcGrandTotal();
  updatePaymentVisibility();

  document.addEventListener('keydown', function(e) {
    if (e.altKey && e.key === '=') {
      e.preventDefault();
      addRow();
    }
  });
});
</script>

{% endblock %}
